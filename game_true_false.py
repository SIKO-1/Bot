import random
from telebot import types

# ูุธุงู ุงูููุงุท ุงููุฑุชุจุท ุจุงูู Volume
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 0}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # ูุงุฆูุฉ ุงูู 50 ุณุคุงูุงู ุงูููุธูุฉ (ุจุฏูู ุฅูููุฌูุงุช ุฏุงุฎููุฉ)
    TF_QUESTIONS = {
        1: {"q": "ุงูุญูุช ูุชููุณ ูู ุงูุฑุฆุชูู ูููุณ ุงูุฎูุงุดูู.", "a": "ุตุญ"},
        2: {"q": "ุงูุดูุณ ุชุฏูุฑ ุญูู ุงูุฃุฑุถ ูุฑุฉ ูู ุณูุฉ.", "a": "ุฎุทุฃ"},
        3: {"q": "ุงูุทูุงุทู ุชูุนุฏ ูุงููุฉ ุนููููุง.", "a": "ุตุญ"},
        4: {"q": "ุงูุฅูุณุงู ูุณุชุฎุฏู 10ูช ููุท ูู ุฏูุงุบู.", "a": "ุฎุทุฃ"},
        5: {"q": "ูููู ููุจุฑู ุฃู ูุถุฑุจ ุงูููุงู ููุณู ุฃูุซุฑ ูู ูุฑุฉ.", "a": "ุตุญ"},
        6: {"q": "ุงูููุฑ ูููู ุถูุกูุง ุฎุงุตูุง ุจู.", "a": "ุฎุทุฃ"},
        7: {"q": "ูุงุจูููู ูุงู ูุตูุฑ ุงููุงูุฉ ุฌุฏูุง ููุงุฑูุฉ ุจุนุตุฑู.", "a": "ุฎุทุฃ"},
        8: {"q": "ุงูุฏูุงุบ ูุง ูุดุนุฑ ุจุงูุฃูู.", "a": "ุตุญ"},
        9: {"q": "ุงูุฐูุจ ูููู ูุณุฑู ุจุงููุฏ ุฅุฐุง ูุงู ููููุง ุฌุฏูุง.", "a": "ุตุญ"},
        10: {"q": "ุงูุฒุฑุงูุฉ ูุง ุชุณุชุทูุน ุฅุตุฏุงุฑ ุฃู ุตูุช.", "a": "ุฎุทุฃ"},
        11: {"q": "ุงููุงุก ูุบูู ุฏุงุฆููุง ุนูุฏ 100 ุฏุฑุฌุฉ ูุฆููุฉ.", "a": "ุฎุทุฃ"},
        12: {"q": "ุงููุทุจ ุงูุฌููุจู ูุงุฑุฉ.", "a": "ุตุญ"},
        13: {"q": "ุงูุถูุฏุน ูุดุฑุจ ุงููุงุก ุนู ุทุฑูู ุฌูุฏู.", "a": "ุตุญ"},
        14: {"q": "ุงูุฅูุณุงู ูููู ุฃูุซุฑ ูู ุฎูุณ ุญูุงุณ.", "a": "ุตุญ"},
        15: {"q": "ุงูุฎูุงุด ุฃุนูู ุชูุงููุง.", "a": "ุฎุทุฃ"},
        16: {"q": "ุงูุฃููุงุณ ูู ุฃูุณู ูุงุฏุฉ ูุนุฑููุฉ ุนูู ุงูุฅุทูุงู.", "a": "ุฎุทุฃ"},
        17: {"q": "ุงููููุฉ ูุฏ ุชุคุซุฑ ุนูู ุงูููู ุญุชู ุจุนุฏ ุณุงุนุงุช.", "a": "ุตุญ"},
        18: {"q": "ุงูุฑุนุฏ ูุงุชุฌ ุนู ุงุตุทุฏุงู ุงูุณุญุจ ุจุจุนุถูุง.", "a": "ุฎุทุฃ"},
        19: {"q": "ุงูููุฒ ูููู ุนูู ุดุฌุฑุฉ.", "a": "ุฎุทุฃ"},
        20: {"q": "ุงูุนุณู ุงูุทุจูุนู ูุง ููุณุฏ ูุน ุงูุฒูู.", "a": "ุตุญ"},
        21: {"q": "ุงูุฃุฑุถ ุฃูุฑุจ ุฅูู ุงูุดูุณ ูู ุงูุตูู.", "a": "ุฎุทุฃ"},
        22: {"q": "ุงูุณูู ูุง ูุดุนุฑ ุจุงูุฃูู.", "a": "ุฎุทุฃ"},
        23: {"q": "ุงูุฅูุณุงู ูุณุชุทูุน ุงูุนูุด ุจุฏูู ุทุญุงู.", "a": "ุตุญ"},
        24: {"q": "ุงูุตูุช ูุง ููุชูู ูู ุงููุฑุงุบ.", "a": "ุตุญ"},
        25: {"q": "ุณูุฑ ุงูุตูู ุงูุนุธูู ูููู ุฑุคูุชู ูู ุงูููุฑ ุจุงูุนูู ุงููุฌุฑุฏุฉ.", "a": "ุฎุทุฃ"},
        26: {"q": "ุงูููู ุงูุฃุญูุฑ ูุซูุฑ ุบุถุจ ุงูุซูุฑ.", "a": "ุฎุทุฃ"},
        27: {"q": "ุงูุฌุณู ูุชููู ุนู ุงูููู ุชูุงููุง ุจุนุฏ ุณู 18.", "a": "ุฎุทุฃ"},
        28: {"q": "ุงูููุฑ ูู ุฌุงูุจ ูุง ูุฑุงู ูู ุงูุฃุฑุถ.", "a": "ุตุญ"},
        29: {"q": "ุงูุฒุฌุงุฌ ุณุงุฆู ุจุทูุก ุงูุญุฑูุฉ.", "a": "ุฎุทุฃ"},
        30: {"q": "ุงูุช ุงุนูู.", "a": "ุตุญ"},
        31: {"q": "ุงููููุฉ ุชูุนุฏ ููุจูููุง ููุฌูุงุฒ ุงูุนุตุจู.", "a": "ุตุญ"},
        32: {"q": "ูู ุงูููุฑูุณุงุช ุชุณุจุจ ุฃูุฑุงุถูุง ุฎุทูุฑุฉ.", "a": "ุฎุทุฃ"},
        33: {"q": "ุงูุทููุฑ ูุง ุชููู ูุซุงูุฉ ุจูููุฉ.", "a": "ุตุญ"},
        34: {"q": "ุงูุฃุฑุถ ููุณุช ูุฑููุฉ ุชูุงููุง ุจู ูููุทุญุฉ ูููููุง.", "a": "ุตุญ"},
        35: {"q": "ุงูุฅูุณุงู ูุณุชุทูุน ุงูุนุทุณ ุฃุซูุงุก ุงูููู ุงูุนููู.", "a": "ุฎุทุฃ"},
        36: {"q": "ุงูุฐุงูุฑุฉ ุชุชุญุณู ุฃุซูุงุก ุงูููู.", "a": "ุตุญ"},
        37: {"q": "ุงููุทุจ ุงูุดูุงูู ุนุจุงุฑุฉ ุนู ูุงุฑุฉ ุฌููุฏูุฉ.", "a": "ุฎุทุฃ"},
        38: {"q": "ุงูุฏู ูู ุฌุณู ุงูุฅูุณุงู ูููู ุฃุฒุฑู.", "a": "ุฎุทุฃ"},
        39: {"q": "ุงูุฅูุณุงู ุฃูุฑุจ ูุฑุงุซููุง ูููุฑุฏ ูู ุงููุท.", "a": "ุตุญ"},
        40: {"q": "ูู ุงููุฌูู ุฃูุจุฑ ูู ุงูุดูุณ.", "a": "ุฎุทุฃ"},
        41: {"q": "ูููู ูููุงุก ุงูููู ุฌุฏูุง ุฃู ูุง ููุตู ุงูููุฑุจุงุก.", "a": "ุตุญ"},
        42: {"q": "ุงูุฅูุณุงู ูููุฏ ุจุนุฏุฏ ุนุธุงู ุฃูู ูู ุงูุจุงูุบ.", "a": "ุฎุทุฃ"},
        43: {"q": "ุงูุญูุงุณ ูููู ุฃู ุชุฎุฏุน ุงูุฏูุงุบ.", "a": "ุตุญ"},
        44: {"q": "ุงูุฃุฑุถ ุชุฏูุฑ ุญูู ูุญูุฑูุง ุฎูุงู 24 ุณุงุนุฉ ุชูุฑูุจูุง.", "a": "ุตุญ"},
        45: {"q": "ูู ุงูุฃุณูุงู ุชุนูุด ูู ุงููุงุก ุงููุงูุญ.", "a": "ุฎุทุฃ"},
        46: {"q": "ุงูุฌูุฏ ูู ุฃูุจุฑ ุนุถู ูู ุฌุณู ุงูุฅูุณุงู.", "a": "ุตุญ"},
        47: {"q": "ุงูุฅูุณุงู ูุณุชุทูุน ุชุฐูู ุงูุทุนุงู ุจุฃููู ุฃูุถูุง.", "a": "ุตุญ"},
        48: {"q": "ุงูุฑุตุงุต ูุบูู ุฃุณุฑุน ูู ุงููุงุก.", "a": "ุฎุทุฃ"},
        49: {"q": "ุงูููู ููู ูุชุฑุชูุจ ุงูุฐูุฑูุงุช.", "a": "ุตุญ"},
        50: {"q": "ุงูุฅูุณุงู ูุณุชุทูุน ุฑุคูุฉ ูู ุฃููุงู ุงูุทูู ุงูุถูุฆู.", "a": "ุฎุทุฃ"}
    }

    @bot.message_handler(func=lambda m: m.text == "ุตุญ")
    def start_tf_game(m):
        q_id = random.choice(list(TF_QUESTIONS.keys()))
        item = TF_QUESTIONS[q_id]
        
        # ุงูุฒุฎุฑูุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ุงููุฎูุฉ
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "      โฏ ุชูุญูุฏู ุตูุญ ู ุฎูุทูุฃ โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            f"  ยป ุงููููุนููููููุฉ : [ {item['q']} ]\n\n"
            "๐ฐ ุงููุฌูุงุฆูุฒุฉ : 50 ููููุทูุฉ"
        )
        
        markup = types.InlineKeyboardMarkup(row_width=2)
        btn_true = types.InlineKeyboardButton("โ ุตูุญ", callback_data=f"tf_{q_id}_ุตุญ")
        btn_false = types.InlineKeyboardButton("โ ุฎูุทูุฃ", callback_data=f"tf_{q_id}_ุฎุทุฃ")
        
        markup.add(btn_true, btn_false)
        bot.reply_to(m, text, reply_markup=markup)

    @bot.callback_query_handler(func=lambda call: call.data.startswith("tf_"))
    def handle_tf_answer(call):
        _, q_id_str, user_choice = call.data.split("_")
        q_id = int(q_id_str)
        item = TF_QUESTIONS[q_id]
        correct_answer = item["a"]
        uid = call.from_user.id
        
        if user_choice == correct_answer:
            points = 50
            bal = get_user(uid).get("balance", 0)
            update_user(uid, "balance", bal + points)
            
            win_text = (
                "โฏ ุชูู ุงููุชูุญูููู ููู ุงูุฅุฌูุงุจูุฉ โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููููุงุฆูุฒ : {call.from_user.first_name}\n"
                "โ ุงูุฅุฌูุงุจูุฉ : ุตูุญูููุญูุฉ (ููู ูุง ุฐูู)\n"
                f"๐ฐ ุงููุฌููุงุฆูุฒ : +{points} ููููุงุท"
            )
            bot.edit_message_text(win_text, chat_id=call.message.chat.id, message_id=call.message.message_id)
        else:
            fail_text = (
                "โฏ ุชูู ุงููุชูุญูููู ููู ุงูุฅุฌูุงุจูุฉ โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููุฎูุงุณูุฑ : {call.from_user.first_name}\n"
                f"โ ุงูุฅุฌูุงุจูุฉ : ุฎูุงุทูุฆูุฉ (ุฑูุฒ ูุง ุจุทู)\n"
                f"๐ก ุงููุตูุญูููุญ : {correct_answer}"
            )
            bot.edit_message_text(fail_text, chat_id=call.message.chat.id, message_id=call.message.message_id)
