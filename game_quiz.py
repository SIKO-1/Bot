import random
from telebot import types

# ูุธุงู ุงูููุงุท ุงููุฑุชุจุท ุจุงูู Volume
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 1000}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # ุงููุงุฆูุฉ ุงููุงููุฉ - 50 ุณุคุงู ุฅูุจุฑุงุทูุฑู
    QUIZ_DATA = [
        {"q": "ูุง ุงุณู ุงููุจู ุงูุฐู ุงุจุชูุนู ุงูุญูุชุ", "opts": ["ูููุณ", "ููุณู", "ููุญ"], "a": "ูููุณ", "lv": 1},
        {"q": "ูู ูุชุจ ูุชุงุจ ุงูุฌูููุฑูุฉุ", "opts": ["ุฃููุงุทูู", "ุฃุฑุณุทู", "ุณูุฑุงุท"], "a": "ุฃููุงุทูู", "lv": 2},
        {"q": "ูุชู ููุนุช ุงูุซูุฑุฉ ุงููุฑูุณูุฉุ", "opts": ["1789", "1776", "1804"], "a": "1789", "lv": 3},
        {"q": "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", "opts": ["ุงูููู", "ุงูุฃูุงุฒูู", "ุงููุณูุณูุจู"], "a": "ุงูููู", "lv": 1},
        {"q": "ูู ูู ุฃูู ุฎูููุฉ ูู ุงูุฅุณูุงูุ", "opts": ["ุฃุจู ุจูุฑ", "ุนูู", "ุนูุฑ"], "a": "ุฃุจู ุจูุฑ", "lv": 1},
        {"q": "ูุง ูู ุงููููุจ ุงูุฃุญูุฑุ", "opts": ["ุงููุฑูุฎ", "ุงูุฒูุฑุฉ", "ุนุทุงุฑุฏ"], "a": "ุงููุฑูุฎ", "lv": 1},
        {"q": "ูู ูุงู ุฃูุง ุฃููุฑ ุฅุฐู ุฃูุง ููุฌูุฏุ", "opts": ["ุฏููุงุฑุช", "ููุชุดู", "ููุฌู"], "a": "ุฏููุงุฑุช", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ุงููุงุจุงูุ", "opts": ["ุทูููู", "ูููุชู", "ุฃูุณุงูุง"], "a": "ุทูููู", "lv": 1},
        {"q": "ูู ุนุฏุฏ ุณูุฑ ุงููุฑุขู ุงููุฑููุ", "opts": ["114", "113", "110"], "a": "114", "lv": 1},
        {"q": "ูู ุงููููุจ ุจุณูู ุงููู ุงููุณูููุ", "opts": ["ุฎุงูุฏ", "ุนูู", "ุณุนุฏ"], "a": "ุฎุงูุฏ", "lv": 1},
        {"q": "ุฃูู ููุนุช ูุนุฑูุฉ ุนูู ุฌุงููุชุ", "opts": ["ููุณุทูู", "ูุตุฑ", "ุณูุฑูุง"], "a": "ููุณุทูู", "lv": 2},
        {"q": "ูุง ูู ุฃุณุฑุน ูุงุฆู ุญูุ", "opts": ["ุงูููุฏ", "ุงูุตูุฑ", "ุงูุณููุฉ ุงูุณูู"], "a": "ุงูุตูุฑ", "lv": 2},
        {"q": "ูู ูู ูุฎุชุฑุน ุงููุตุจุงุญ ุงูููุฑุจุงุฆูุ", "opts": ["ุฅุฏูุณูู", "ุชุณูุง", "ุฏุง ูููุดู"], "a": "ุฅุฏูุณูู", "lv": 1},
        {"q": "ูุง ูู ุฃูุจุฑ ูุงุฑุฉ ูู ุงูุนุงููุ", "opts": ["ุขุณูุง", "ุฃูุฑูููุง", "ุฃูุฑูุจุง"], "a": "ุขุณูุง", "lv": 1},
        {"q": "ูู ุนุฏุฏ ุฃููุงู ููุณ ูุฒุญุ", "opts": ["7 ุฃููุงู", "6 ุฃููุงู", "8 ุฃููุงู"], "a": "7 ุฃููุงู", "lv": 1},
        {"q": "ูู ูู ููุชุดู ุงูุฌุงุฐุจูุฉุ", "opts": ["ูููุชู", "ุฃููุดุชุงูู", "ุฌุงูููู"], "a": "ูููุชู", "lv": 1},
        {"q": "ูุง ูู ุนุงุตูุฉ ูุฑูุณุงุ", "opts": ["ุจุงุฑูุณ", "ููุฏู", "ุฑููุง"], "a": "ุจุงุฑูุณ", "lv": 1},
        {"q": "ูุง ูู ุฃูุจุฑ ูุญูุท ูู ุงูุนุงููุ", "opts": ["ุงููุงุฏุฆ", "ุงูุฃุทูุณู", "ุงูููุฏู"], "a": "ุงููุงุฏุฆ", "lv": 1},
        {"q": "ูู ุจูู ุงูุฃูุฑุงูุงุชุ", "opts": ["ุงููุฑุงุนูุฉ", "ุงูุฑูู", "ุงููููุงู"], "a": "ุงููุฑุงุนูุฉ", "lv": 1},
        {"q": "ูุง ูู ุงูุบุงุฒ ุงูุถุฑูุฑู ููุชููุณุ", "opts": ["ุงูุฃูุณุฌูู", "ุงูููุชุฑูุฌูู", "ุงูููุฏุฑูุฌูู"], "a": "ุงูุฃูุณุฌูู", "lv": 1},
        {"q": "ูุง ูู ุนููุฉ ุงููุงุจุงูุ", "opts": ["ุงููู", "ุงูููุงู", "ุงูุฏููุงุฑ"], "a": "ุงููู", "lv": 2},
        {"q": "ูู ูู ูุงุชุจ ูุณุฑุญูุฉ ูุงููุชุ", "opts": ["ุดูุณุจูุฑ", "ูููููุฑ", "ุชููุณุชูู"], "a": "ุดูุณุจูุฑ", "lv": 2},
        {"q": "ูุง ูู ุฃุตุบุฑ ุฏููุฉ ูู ุงูุนุงููุ", "opts": ["ุงููุงุชููุงู", "ูููุงูู", "ุณุงู ูุงุฑููู"], "a": "ุงููุงุชููุงู", "lv": 2},
        {"q": "ูู ุฃู ุณูุฉ ุจุฏุฃุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุฃูููุ", "opts": ["1914", "1918", "1939"], "a": "1914", "lv": 2},
        {"q": "ูุง ูู ุงููุนุฏู ุงูุณุงุฆู ูู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงูุนุงุฏูุฉุ", "opts": ["ุงูุฒุฆุจู", "ุงูุญุฏูุฏ", "ุงููุญุงุณ"], "a": "ุงูุฒุฆุจู", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ุฅูุทุงููุงุ", "opts": ["ุฑููุง", "ูููุงูู", "ููููุณูุง"], "a": "ุฑููุง", "lv": 1},
        {"q": "ูู ูู ุฃูู ุฅูุณุงู ุตุนุฏ ููููุฑุ", "opts": ["ุฃุฑูุณุชุฑููุฌ", "ุฌุงุฌุงุฑูู", "ูููููุฒ"], "a": "ุฃุฑูุณุชุฑููุฌ", "lv": 2},
        {"q": "ูุง ูู ุงูุญููุงู ุงูุฐู ูููุจ ุจุณูููุฉ ุงูุตุญุฑุงุกุ", "opts": ["ุงูุฌูู", "ุงูุญุตุงู", "ุงูุญูุงุฑ"], "a": "ุงูุฌูู", "lv": 1},
        {"q": "ูู ุนุฏุฏ ุฃุณูุงู ุงูุฅูุณุงู ุงูุจุงูุบุ", "opts": ["32", "28", "30"], "a": "32", "lv": 2},
        {"q": "ูุง ูู ุงูุนุถู ุงููุณุคูู ุนู ุชุตููุฉ ุงูุฏูุ", "opts": ["ุงูููู", "ุงูููุจ", "ุงููุจุฏ"], "a": "ุงูููู", "lv": 2},
        {"q": "ูุง ูู ุฃูุจุฑ ุญููุงู ูู ุงูุนุงููุ", "opts": ["ุงูุญูุช ุงูุฃุฒุฑู", "ุงูููู", "ุงูุฒุฑุงูุฉ"], "a": "ุงูุญูุช ุงูุฃุฒุฑู", "lv": 1},
        {"q": "ูู ูู ุตุงุญุจ ููุจ ุงููุงุฑููุ", "opts": ["ุนูุฑ ุจู ุงูุฎุทุงุจ", "ุฃุจู ุจูุฑ", "ุนุซูุงู"], "a": "ุนูุฑ ุจู ุงูุฎุทุงุจ", "lv": 1},
        {"q": "ูุง ูู ุงูุนูู ุงูุฐู ูุฏุฑุณ ุงููุฌููุ", "opts": ["ุงูููู", "ุงูููุฒูุงุก", "ุงูููููุงุก"], "a": "ุงูููู", "lv": 1},
        {"q": "ูุง ูู ุนุงุตูุฉ ุงูุณุนูุฏูุฉุ", "opts": ["ุงูุฑูุงุถ", "ุฌุฏุฉ", "ููุฉ"], "a": "ุงูุฑูุงุถ", "lv": 1},
        {"q": "ูู ูู ุงูุฑุณุงู ุงูุฐู ุฑุณู ุงููููุงููุฒุงุ", "opts": ["ุฏุง ูููุดู", "ุจููุงุณู", "ูุงู ุฌูุฎ"], "a": "ุฏุง ูููุดู", "lv": 2},
        {"q": "ูุง ูู ุฃุตูุจ ูุงุฏุฉ ุทุจูุนูุฉุ", "opts": ["ุงูุฃููุงุณ", "ุงูุฐูุจ", "ุงูุญุฏูุฏ"], "a": "ุงูุฃููุงุณ", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ูุตุฑุ", "opts": ["ุงููุงูุฑุฉ", "ุงูุฅุณููุฏุฑูุฉ", "ุฃุณูุงู"], "a": "ุงููุงูุฑุฉ", "lv": 1},
        {"q": "ูู ุนุฏุฏ ูุงุฑุงุช ุงูุนุงููุ", "opts": ["7", "6", "5"], "a": "7", "lv": 1},
        {"q": "ูุง ูู ุงูุทุงุฆุฑ ุงูุฐู ูุง ูุทูุฑุ", "opts": ["ุงููุนุงูุฉ", "ุงูุนุตููุฑ", "ุงูุญูุงู"], "a": "ุงููุนุงูุฉ", "lv": 1},
        {"q": "ูู ูู ูุคุณุณ ุงูุฏููุฉ ุงูุฃูููุฉุ", "opts": ["ูุนุงููุฉ", "ูุฒูุฏ", "ูุฑูุงู"], "a": "ูุนุงููุฉ", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ุฑูุณูุงุ", "opts": ["ููุณูู", "ููุฏู", "ุจุฑููู"], "a": "ููุณูู", "lv": 1},
        {"q": "ูุง ูู ุฃูุฑุจ ูููุจ ููุดูุณุ", "opts": ["ุนุทุงุฑุฏ", "ุงูุฒูุฑุฉ", "ุงูุฃุฑุถ"], "a": "ุนุทุงุฑุฏ", "lv": 1},
        {"q": "ูุง ูู ูุบุฉ ุงูุจุฑุงุฒูู ุงูุฑุณููุฉุ", "opts": ["ุงูุจุฑุชุบุงููุฉ", "ุงูุฅุณุจุงููุฉ", "ุงูุฅูุฌููุฒูุฉ"], "a": "ุงูุจุฑุชุบุงููุฉ", "lv": 2},
        {"q": "ูู ุนุฏุฏ ูุงุนุจู ูุฑูู ูุฑุฉ ุงููุฏูุ", "opts": ["11", "10", "12"], "a": "11", "lv": 1},
        {"q": "ูุง ูู ุฃุทูู ุณูุฑ ูู ุงูุนุงููุ", "opts": ["ุณูุฑ ุงูุตูู", "ุณูุฑ ุจุฑููู", "ุณูุฑ ุงููุฏุณ"], "a": "ุณูุฑ ุงูุตูู", "lv": 1},
        {"q": "ูู ูู ุงููุจู ุงููููุจ ุจูููู ุงูููุ", "opts": ["ููุณู", "ุนูุณู", "ุฅุจุฑุงููู"], "a": "ููุณู", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ุงูุนุฑุงูุ", "opts": ["ุจุบุฏุงุฏ", "ุงูุจุตุฑุฉ", "ุฃุฑุจูู"], "a": "ุจุบุฏุงุฏ", "lv": 1},
        {"q": "ูู ุนุฏุฏ ุงูููุงูุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", "opts": ["8", "9", "7"], "a": "8", "lv": 2},
        {"q": "ูุง ูู ุงูุนูุตุฑ ุงูููููุงุฆู ููููุงุกุ", "opts": ["ููุชุฑูุฌูู", "ุฃูุณุฌูู", "ุฎููุท"], "a": "ุฎููุท", "lv": 3},
        {"q": "ูู ูู ููุชุดู ุฃูุฑููุงุ", "opts": ["ูููููุจูุณ", "ูุงุฌูุงู", "ูุงุณูู"], "a": "ูููููุจูุณ", "lv": 2}
    ]

    @bot.message_handler(func=lambda m: m.text == "ุณุคุงู")
    def start_quiz(m):
        q_item = random.choice(QUIZ_DATA)
        q_idx = QUIZ_DATA.index(q_item)
        
        lv_map = {1: "๐ข ุณูู", 2: "๐ก ูุชูุณุท", 3: "๐ด ุตุนุจ"}
        prize_map = {1: 100, 2: 200, 3: 300}
        
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "         โฏ ุชูุญูุฏู ุงููุณูุคุงู โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            f"  ยป ุงููููุณูุชููู : {lv_map[q_item['lv']]}\n"
            f"  ยป ุงููุฌูุงุฆูุฒุฉ : {prize_map[q_item['lv']]} ููููุทูุฉ\n\n"
            f"โ [ {q_item['q']} ]"
        )
        
        markup = types.InlineKeyboardMarkup(row_width=2)
        # ุงุณุชุฎุฏุงู ุงูู index ููุท ูุถูุงู ุนุฏู ุชุนููู ุงูุจูุช ููุงุฆูุงู
        btns = [types.InlineKeyboardButton(opt, callback_data=f"q_{q_idx}_{opt}") for opt in q_item['opts']]
        
        random.shuffle(btns)
        markup.add(*btns)
        bot.send_message(m.chat.id, text, reply_markup=markup)

    @bot.callback_query_handler(func=lambda call: call.data.startswith("q_"))
    def handle_quiz(call):
        uid = call.from_user.id
        _, q_idx, user_choice = call.data.split("_")
        q_item = QUIZ_DATA[int(q_idx)]
        user_bal = get_user(uid).get("balance", 0)

        if user_choice == q_item["a"]:
            reward = {1: 100, 2: 200, 3: 300}[q_item['lv']]
            update_user(uid, "balance", user_bal + reward)
            res_text = (
                "โฏ ููุชูููุฌูุฉ ุงููุชูุญูุฏู โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููููุงุฆูุฒ : {call.from_user.first_name}\n"
                "โ ุงูุฅุฌูุงุจูุฉ : ุตูุญูููุญูุฉ\n"
                f"๐ฐ ุงููุฌููุงุฆูุฒ : +{reward} ููููุทูุฉ"
            )
        else:
            update_user(uid, "balance", max(0, user_bal - 50))
            res_text = (
                "โฏ ููุชูููุฌูุฉ ุงููุชูุญูุฏู โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููุฎูุงุณูุฑ : {call.from_user.first_name}\n"
                "โ ุงูุฅุฌูุงุจูุฉ : ุฎูุงุทูุฆูุฉ\n"
                f"๐ก ุงููุตูุญูููุญ : {q_item['a']}"
            )
        
        bot.edit_message_text(res_text, chat_id=call.message.chat.id, message_id=call.message.message_id)
