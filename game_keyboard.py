import random
import time
from telebot import types
from db_manager import get_user, update_user

def register_handlers(bot):
    
    # ุงููุงุฆูุฉ ุงููุฎูุฉ (50 ุชุญุฏู)
    KEYBOARD_WORDS = [
        "ูุณุทูุทูููุฉ", "ูุณููููููู ุงููู", "ุงุณุชุณูููุงููููุง", "ูุฃุณูููุงูููู", "ููุณุชุฎููููู",
        "ูุณุชุถุนููู", "ุณูุฌุนู ููู ุงูุฑุญูู ููุฏููุง", "ุฃูุบูุฑู ุงููู ุชุฃูุฑููู", "ูุฃูุฌููุงู ูุฃููู", "ุงููุชุดุงุจูุงุช",
        "ุฃุชุญุงุฌูููู ูู ุงููู", "ูุชูุงุฑูุง ูู ุฃูุฑูู", "ุณููุฒู ุงูุฌูุน ููููููู ุงูุฏุจุฑ", "ุงุณุชูุจุฑูุง ูุงุณุชุนุชูุง", "ูุฃูุณุงูู ุฃููุณูู",
        "ูุณุชูุจุฑูู ุจู ุณุงูุฑูุง", "ููุณุชุฎููููู ูู ุงูุฃุฑุถ", "ุฃูุชุทูุนูู ุฃู ูุคูููุง ููู", "ูุฏูุฏู ุนูููู ุฑุจูู", "ูุฌุนููู ุฎูุงุฆู",
        "ุงูุฅุณููุฏุฑูุฉ", "ูููููุง ุชุณูุง", "ุงูุฅูุจุฑุงุทูุฑูุฉ", "ุงูุงุณุชุนูุงุฑูุฉ", "ุงูููุชุงููุฒูููุง",
        "ุงููุงูุฑูุฒูุฉ", "ุงูุณูููููุฌูุง", "ุงูุฃูุซุฑูุจูููุฌูุง", "ุงูุฅูุฏููููุฌูุงุช", "ุงูุงุณุชุดุฑุงู",
        "ูุชูุงูุถุงุช", "ุงุณุชุญุงูุฉ", "ุงุณุชุฐูุงุฑ", "ุงููุงูุนู", "ููู ุฅุฏุฑุงูู",
        "ุชุดุธูู", "ุงููุณุงุฑุงุช", "ุชููุถุน", "ุชูุงูู", "ุงููุฌูุฏูุฉ",
        "ุงุณุชุจุทุงู", "ูุงูุฑุงุฆูุงุช", "ุงุณุชูุฑุงุก", "ุงุณุชูุจุงุท", "ุชุฏุงุฎูุงุช",
        "ุงููุงูุญุฏูุฏูุฉ", "ุชุดุงุจูุงุช", "ุงุญุชูุงูุงุช", "ููุถููุฉ", "ุนุจุซููุฉ"
    ]

    # ุชุฎุฒูู ุงูุชุญุฏู ุงูุญุงูู ููู ูุฌููุนุฉ
    active_challenges = {}

    @bot.message_handler(func=lambda m: m.text == "ููุจูุฑุฏ")
    def start_keyboard_game(m):
        chat_id = m.chat.id
        word = random.choice(KEYBOARD_WORDS)
        
        # ุชุฎุฒูู ุงููููุฉ ูุงูููุช
        active_challenges[chat_id] = {
            "word": word,
            "winner": None,
            "start_time": time.time()
        }
        
        msg = (f"โจ๏ธ **ุชุญุฏู ุงูููุจูุฑุฏ ุจุฏุฃ!**\n\n"
               f"ุฃุณุฑุน ูุงุญุฏ ููุชุจ ุงููููุฉ ุงูุชุงููุฉ:\n"
               f"โจ ` {word} ` โจ\n\n"
               f"๐ก (ุงุถุบุท ุนูู ุงููููุฉ ููุณุฎูุง ูู ููุช ุนุฌุงุฒ)")
        
        bot.send_message(chat_id, msg, parse_mode="Markdown")

    @bot.message_handler(func=lambda m: m.chat.id in active_challenges)
    def check_typing_speed(m):
        chat_id = m.chat.id
        challenge = active_challenges[chat_id]
        
        # ุฅุฐุง ูุงู ุงูุดุฎุต ูุชุจ ุงููููุฉ ุตุญูุญุฉ ููู ููุฒ ุฃุญุฏ ูุจูู
        if m.text == challenge["word"] and not challenge["winner"]:
            challenge["winner"] = m.from_user.id
            elapsed_time = round(time.time() - challenge["start_time"], 2)
            
            # ุชุญุฏูุซ ุงูููุงุท (ูุนุทูู 100 ููุทุฉ ููุณุฑุนุฉ)
            user_data = get_user(m.from_user.id)
            update_user(m.from_user.id, "balance", user_data["balance"] + 100)
            
            bot.reply_to(m, f"โ **ูุญุด ุงูููุจูุฑุฏ!**\n\n"
                            f"ููู ูุง {m.from_user.first_name}ุ ูุชุจุช ุงููููุฉ ูู {elapsed_time} ุซุงููุฉ.\n"
                            f"๐ฐ ุชู ุฅุถุงูุฉ 100 ููุทุฉ ูุฑุตูุฏู.")
            
            # ุงูุชูุงุก ุงูุชุญุฏู ููุฐู ุงููููุฉ
            # ูุง ููุณุญ ุงูุชุญุฏู ููุฑุงู ููู ูุชููู ูู ุงูุณุฎุฑูุฉ ูู ุงููุชุฃุฎุฑูู
            time.sleep(1) 
            
        # ุฅุฐุง ูุชุจ ุงููููุฉ ุตุญูุญุฉ ูููู "ุจุทูุก" (ุฌุงุก ุจุนุฏ ุงููุงุฆุฒ)
        elif m.text == challenge["word"] and challenge["winner"]:
            slow_replies = [
                "ุจุฏุฑู ูุง ุจุทู! ุงูููุฒ ูุบูุฑูุ ุฎููู ุฃุณุฑุน ุงููุฑุฉ ุงูุฌุงูุฉ ๐ข",
                "ูุง ุจุทูุก! ุงููุงุณ ูุงุฒุช ูุงุนุชุฒูุช ูุฃูุช ุชูู ุชูุชุจุ ๐",
                "ูุถุนูู! ุฃุตุงุจุนู ูุจูููุง ุชุดุญูู ๐ง",
                "ูุณูู ูููุง ุณุฑูุนุ ูุงุชู ุงููุทุงุฑ ูุง ูุงุจุชู ๐",
                "ุดููู ุชูุชุจ ุจุตุจุงุน ูุงุญุฏ.. ุตุญุ ๐คก"
            ]
            bot.reply_to(m, random.choice(slow_replies))
            
            # ุงูุขู ููุณุญ ุงูุชุญุฏู ูู ุงูุฐุงูุฑุฉ ููู ูุง ูุณุชูุฑ ุงูุจูุช ูู ุงูุณุฎุฑูุฉ ููุฃุจุฏ
            del active_challenges[chat_id]

