import random
import db_manager

def register_handlers(bot):
    
    RANKS = {
        "Ù…Ø¨ØªØ¯Ø¦": 0, "Ù…ÙƒØ§ÙØ­": 50, "ØµÙŠØ§Ø¯": 150, "Ø¬Ù†Ø¯ÙŠ": 300, "ÙØ§Ø±Ø³": 500,
        "Ù…ØºÙˆØ§Ø±": 800, "Ù‚Ù†Ø§Øµ": 1200, "Ø²Ø¹ÙŠÙ…": 2000, "Ø´ÙŠØ®": 3500, "Ø¨Ø§Ø´Ø§": 5000,
        "Ø³ÙÙŠØ±": 7000, "ÙˆØ²ÙŠØ±": 10000, "Ø­Ø§ÙƒÙ…": 15000, "Ø³Ù„Ø·Ø§Ù†": 20000, "Ù…Ù„Ùƒ": 30000,
        "Ø¯ÙˆÙ‚": 40000, "Ø¨Ø§Ø±ÙˆÙ†": 50000, "ÙƒÙˆÙ†Øª": 60000, "Ù…Ø§Ø±ÙƒÙŠØ²": 75000, "Ø£Ù…ÙŠØ±": 100000,
        "ÙˆÙ„ÙŠ Ø¹Ù‡Ø¯": 150000, "Ø¬Ù†Ø±Ø§Ù„": 250000, "Ù…Ø´ÙŠØ±": 400000, "Ø£Ø³Ø·ÙˆØ±Ø©": 700000, "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±": 9999999
    }

    ROYAL_QUOTES = [
        "Ø¥Ù† Ø§Ù„Ù…Ø¬Ø¯ Ù„Ø§ ÙŠÙÙ†Ø§Ù„ Ø¥Ù„Ø§ Ø¨Ø§Ù„ØµØ¨Ø± ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© ÙÙŠ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ø±Ø´.",
        "Ø§Ù„Ù‚Ù…Ø© Ù„ÙŠØ³Øª Ù…ÙƒØ§Ù†Ø§Ù‹ Ù†ØµÙ„ Ø¥Ù„ÙŠÙ‡ØŒ Ø¨Ù„ Ù‡ÙŠ Ù…Ù‚Ø§Ù… Ù†Ù„ÙŠÙ‚ Ø¨Ù‡ Ø¨Ø£ÙØ¹Ø§Ù„Ù†Ø§.",
        "Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© ÙŠØªØ·Ù„Ø¨ Ø±Ø¬Ø§Ù„Ø§Ù‹ Ù„Ø§ ØªØ¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„."
    ]

    # 1. Ø£Ù…Ø± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ (Ø£ÙˆÙ„ÙˆÙŠØ© Ù…Ø·Ù„Ù‚Ø©)
    @bot.message_handler(func=lambda m: m.text in ["Ù…Ø³ØªÙˆÙ‰", "Ù…Ø³ØªÙˆØ§ÙŠ"])
    def level_command(m):
        u = db_manager.get_user(m.from_user.id)
        lvl, xp, rank = u['level'], u['xp'], u.get('rank', 'Ù…Ø¨ØªØ¯Ø¦')
        needed = lvl * (10 * ((lvl // 50) + 1))
        
        status = (
            "ğŸ› **ÙˆØ«Ù€ÙŠÙ€Ù‚Ù€Ø© Ø§Ù„Ù€Ø­Ù€Ø§Ù„Ù€Ø© Ø§Ù„Ù€Ù…Ù€Ù„Ù€ÙƒÙ€ÙŠÙ€Ø©** ğŸ›\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            f"ğŸ‘¤ Ø§Ù„Ù€Ø­Ù€Ø§Ù…Ù€Ù„ : {m.from_user.first_name}\n"
            f"ğŸ“œ Ø§Ù„Ù€Ø±ØªØ¨Ù€Ø© : {rank}\n"
            f"â­ Ø§Ù„Ù€Ù…Ù€Ø³Ù€ØªÙ€ÙˆÙ‰ : {lvl}\n"
            f"ğŸ’  Ø§Ù„Ù€Ù†Ù€Ù‚Ù€Ø§Ø· : {xp} / {needed}\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        )
        bot.reply_to(m, status)

    # 2. Ø£Ù…Ø± Ø§Ù„Ø±ØªØ¨ ÙƒØ§Ù…Ù„Ø©
    @bot.message_handler(func=lambda m: m.text == "Ø±ØªØ¨")
    def ranks_command(m):
        txt = "ğŸ“œ **Ø³Ù€Ø¬Ù€Ù„ Ø§Ù„Ù€Ù…Ù€Ø±Ø§ØªÙ€Ø¨ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠÙ€Ø©** ğŸ“œ\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        for i, (name, price) in enumerate(RANKS.items()):
            p_label = "Ø³ÙŠØ§Ø¯ÙŠ" if name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±" else f"{price} Ø°Ù‡Ø¨Ø©"
            txt += f"âšœï¸ {name} : {p_label}\n"
            if (i+1) % 5 == 0: txt += "â€”\n"
        bot.reply_to(m, txt)

    # 3. Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±ØªØ¨Ø©
    @bot.message_handler(func=lambda m: m.text and m.text.startswith("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© "))
    def buy_rank_command(m):
        rank_name = m.text.replace("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© ", "").strip()
        uid = str(m.from_user.id)
        if rank_name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±":
            bot.reply_to(m, "âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù„ÙƒÙŠ:** Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¡ Ù…Ù‚Ø§Ù… Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±.")
            return
        if rank_name in RANKS:
            price = RANKS[rank_name]
            if db_manager.get_balance(uid) >= price:
                db_manager.update_balance(uid, -price)
                db_manager.set_rank(uid, rank_name)
                bot.reply_to(m, f"âœ… **Ù…Ø±Ø³ÙˆÙ… Ù…Ù„ÙƒÙŠ:** ØªÙ…Øª ØªØ±Ù‚ÙŠØªÙƒÙ… Ø¥Ù„Ù‰ Ø±ØªØ¨Ø© {rank_name}.")
            else:
                bot.reply_to(m, "âŒ **Ø¹ÙÙˆØ§Ù‹:** Ø®Ø²ÙŠÙ†ØªÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ø§ ØªÙƒÙÙŠ.")

    # 4. Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (ÙŠØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù€ XP)
    @bot.message_handler(func=lambda m: True)
    def background_xp(m):
        # Ù…ØµÙØ§Ø©: Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† Ø£Ù…Ø±ØŒ ØªÙˆÙ‚Ù Ù‡Ù†Ø§ ÙˆÙ„Ø§ ØªØ²Ø¯ XP ÙˆÙ„Ø§ ØªØ±Ø¯ Ø¨Ø´ÙŠØ¡
        if m.text in ["Ù…Ø³ØªÙˆÙ‰", "Ù…Ø³ØªÙˆØ§ÙŠ", "Ø±ØªØ¨", "Ø±ØªØ¨ØªÙŠ", "Ù…ØªØ¬Ø±", "Ù…Ø¹Ø±Ø¶"]:
            return

        # Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        leveled_up, new_lvl = db_manager.update_xp(m.from_user.id, 5)
        if leveled_up:
            gift = random.randint(1, 500)
            db_manager.update_balance(m.from_user.id, gift)
            quote = random.choice(ROYAL_QUOTES)
            
            bot.reply_to(m, (
                "ğŸº **Ù…Ù€Ø±Ø³Ù€ÙˆÙ… Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠ** ğŸº\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                f"ØªÙ‚Ø±Ø± ØªØ±Ù‚ÙŠØªÙƒÙ… Ù„Ù„Ù…Ø³ØªÙˆÙ‰ : {new_lvl}\n"
                f"Ø¨Ù…Ù†Ø­Ø© Ù…Ù„ÙƒÙŠØ© Ù‚Ø¯Ø±Ù‡Ø§ : {gift} Ø°Ù‡Ø¨Ø©\n\n"
                f"ğŸ“œ {quote}\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            ))
