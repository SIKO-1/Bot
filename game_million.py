import random
from telebot import types
import db_manager # ุงูุฑุจุท ุจุงูุฎุฒูุฉ ุงูููููุฉ

def register_handlers(bot):
    
    # ุงูุจูู ุงููุงูู ูุฃุณุฆูุฉ ุงูููููู (45 ุณุคุงู) - ููุง ูู ุจุฏูู ุชุบููุฑ
    QUESTIONS_DB = {
        "easy": [
            {"q": "ูุง ูู ููู ุงูุณูุงุก ูู ุงูููุงุฑ ุงูุตุงููุ", "o": ["ุฃุฒุฑู", "ุฃุฎุถุฑ", "ุฃุญูุฑ"], "a": "ุฃุฒุฑู"},
            {"q": "ูู ุนุฏุฏ ุฃูุงู ุงูุฃุณุจูุนุ", "o": ["7", "6", "5"], "a": "7"},
            {"q": "ูุง ูู ุงูุญููุงู ููู ุงูุบุงุจุฉุ", "o": ["ุงูุฃุณุฏ", "ุงูููุฑ", "ุงูููู"], "a": "ุงูุฃุณุฏ"},
            {"q": "ุฃูุฑุจ ูููุจ ุฅูู ุงูุดูุณุ", "o": ["ุนุทุงุฑุฏ", "ุงููุฑูุฎ", "ุงูุฃุฑุถ"], "a": "ุนุทุงุฑุฏ"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงูุนุฑุงูุ", "o": ["ุจุบุฏุงุฏ", "ุงูุจุตุฑุฉ", "ุงูููุตู"], "a": "ุจุบุฏุงุฏ"},
            {"q": "ูู ุนุฏุฏ ุฃุตุงุจุน ุงููุฏ ุงููุงุญุฏุฉุ", "o": ["5", "6", "4"], "a": "5"},
            {"q": "ูุง ูู ุตูุช ุงููุทุฉุ", "o": ["ููุงุก", "ุตููู", "ูุจุงุญ"], "a": "ููุงุก"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงูุณุนูุฏูุฉุ", "o": ["ุงูุฑูุงุถ", "ุฌุฏุฉ", "ููุฉ"], "a": "ุงูุฑูุงุถ"},
            {"q": "ูู ุนุฏุฏ ุฃููุงู ููุณ ูุฒุญุ", "o": ["7", "6", "8"], "a": "7"},
            {"q": "ูุง ูู ุงูุดูุก ุงูุฐู ูุทูุฑ ูู ุงูุณูุงุกุ", "o": ["ุงูุทุงุฆุฑุฉ", "ุงูุณูููุฉ", "ุงููุทุงุฑ"], "a": "ุงูุทุงุฆุฑุฉ"},
            {"q": "ูุง ูู ููู ุงูุบุฑุงุจุ", "o": ["ุฃุณูุฏ", "ุฃุจูุถ", "ุฃุฒุฑู"], "a": "ุฃุณูุฏ"},
            {"q": "ุฃู ุดูุฑ ูุฃุชู ุจุนุฏ ููุงูุฑุ", "o": ["ูุจุฑุงูุฑ", "ูุงุฑุณ", "ุฃุจุฑูู"], "a": "ูุจุฑุงูุฑ"},
            {"q": "ูุง ูู ุนุงุตูุฉ ูุตุฑุ", "o": ["ุงููุงูุฑุฉ", "ุฃุณูุงู", "ุงูุฅุณููุฏุฑูุฉ"], "a": "ุงููุงูุฑุฉ"},
            {"q": "ูู ุนุฏุฏ ุนููู ุงูุฅูุณุงูุ", "o": ["2", "1", "3"], "a": "2"},
            {"q": "ูุง ูู ุงููุงุฏุฉ ุงูุชู ุชุดุฑุจูุง ููุนูุดุ", "o": ["ุงููุงุก", "ุงูุฑูู", "ุงูุฎุดุจ"], "a": "ุงููุงุก"}
        ],
        "medium": [
            {"q": "ูู ูู ูุคูู ูุณุฑุญูุฉ ูุงููุชุ", "o": ["ุดูุณุจูุฑ", "ุฏูููุฒ", "ุชููุณุชูู"], "a": "ุดูุณุจูุฑ"},
            {"q": "ูู ุนุฏุฏ ูุงุฑุงุช ุงูุนุงููุ", "o": ["7", "6", "5"], "a": "7"},
            {"q": "ูุง ูู ุฃุณุฑุน ุญููุงู ุจุฑูุ", "o": ["ุงูููุฏ", "ุงูุฃุณุฏ", "ุงูุญุตุงู"], "a": "ุงูููุฏ"},
            {"q": "ูุฎุชุฑุน ุงููุตุจุงุญ ุงูููุฑุจุงุฆูุ", "o": ["ุฅุฏูุณูู", "ูููุชู", "ุชุณูุง"], "a": "ุฅุฏูุณูู"},
            {"q": "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", "o": ["ุงูููู", "ุงูุฃูุงุฒูู", "ุงููุฑุงุช"], "a": "ุงูููู"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงููุงุจุงูุ", "o": ["ุทูููู", "ุจููู", "ุณููู"], "a": "ุทูููู"},
            {"q": "ูู ูู ููุชุดู ุงูุฌุงุฐุจูุฉุ", "o": ["ูููุชู", "ุฃููุดุชุงูู", "ุฌุงูููู"], "a": "ูููุชู"},
            {"q": "ูุง ูู ุนููุฉ ุงูููุงูุงุช ุงููุชุญุฏุฉุ", "o": ["ุงูุฏููุงุฑ", "ุงูููุฑู", "ุงููู"], "a": "ุงูุฏููุงุฑ"},
            {"q": "ูู ุฃู ูุงุฑุฉ ุชูุน ูุตุฑุ", "o": ["ุฃูุฑูููุง", "ุขุณูุง", "ุฃูุฑูุจุง"], "a": "ุฃูุฑูููุง"},
            {"q": "ูุง ูู ุงููููุจ ุงูุฃุญูุฑุ", "o": ["ุงููุฑูุฎ", "ุฒุญู", "ุงููุดุชุฑู"], "a": "ุงููุฑูุฎ"},
            {"q": "ูู ุนุฏุฏ ูุงุนุจู ูุฑูู ูุฑุฉ ุงููุฏูุ", "o": ["11", "10", "12"], "a": "11"},
            {"q": "ูุง ูู ุฃูุจุฑ ูุงุฑุฉ ูู ุงูุนุงููุ", "o": ["ุขุณูุง", "ุฃูุฑูููุง", "ุฃูุฑูุจุง"], "a": "ุขุณูุง"},
            {"q": "ูุง ูู ุงููุนุฏู ุงูุณุงุฆูุ", "o": ["ุงูุฒุฆุจู", "ุงูุญุฏูุฏ", "ุงููุญุงุณ"], "a": "ุงูุฒุฆุจู"},
            {"q": "ูู ูู ุฃูู ุฅูุณุงู ุตุนุฏ ููููุฑุ", "o": ["ุฃุฑูุณุชุฑููุบ", "ุฌุงุฌุงุฑูู", "ูููููุจูุณ"], "a": "ุฃุฑูุณุชุฑููุบ"},
            {"q": "ูุง ูู ูุบุฉ ุงูุจุฑุงุฒููุ", "o": ["ุงูุจุฑุชุบุงููุฉ", "ุงูุฅุณุจุงููุฉ", "ุงูุฅูุฌููุฒูุฉ"], "a": "ุงูุจุฑุชุบุงููุฉ"}
        ],
        "hard": [
            {"q": "ูู ูู ูุคุณุณ ุนูู ุงูุงุฌุชูุงุนุ", "o": ["ุงุจู ุฎูุฏูู", "ุฃููุงุทูู", "ุฃุฑุณุทู"], "a": "ุงุจู ุฎูุฏูู"},
            {"q": "ุงูุนูุตุฑ ุงูุฃูุซุฑ ููุฑุฉ ูู ุงููููุ", "o": ["ุงูููุฏุฑูุฌูู", "ุงูุฃูุณุฌูู", "ุงููููููู"], "a": "ุงูููุฏุฑูุฌูู"},
            {"q": "ุนุงู ุณููุท ุจุบุฏุงุฏ ุจูุฏ ุงููุบููุ", "o": ["1258", "1200", "1300"], "a": "1258"},
            {"q": "ุฃุตุบุฑ ูููุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", "o": ["ุนุทุงุฑุฏ", "ุงููุฑูุฎ", "ุจููุชู"], "a": "ุนุทุงุฑุฏ"},
            {"q": "ูุง ูู ุฃุทูู ุณูุฑุฉ ูู ุงููุฑุขูุ", "o": ["ุงูุจูุฑุฉ", "ุงููุณุงุก", "ุงูุฃุนุฑุงู"], "a": "ุงูุจูุฑุฉ"},
            {"q": "ูู ูุงู: ุฃูุง ุฃููุฑ ุฅุฐู ุฃูุง ููุฌูุฏุ", "o": ["ุฏููุงุฑุช", "ูุงูุท", "ููุชุดู"], "a": "ุฏููุงุฑุช"},
            {"q": "ูู ุนุฏุฏ ุงูุนุธุงู ูู ุฌุณู ุงูุฅูุณุงู ุงูุจุงูุบุ", "o": ["206", "210", "200"], "a": "206"},
            {"q": "ุฃู ุฏููุฉ ุงุฎุชุฑุนุช ุงููุฑูุ", "o": ["ุงูุตูู", "ุงูููุฏ", "ูุตุฑ"], "a": "ุงูุตูู"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ุงูุจูุฒูุทูุฉุ", "o": ["ุงููุณุทูุทูููุฉ", "ุฑููุง", "ุฃุซููุง"], "a": "ุงููุณุทูุทูููุฉ"},
            {"q": "ูุง ูู ุงูุงุณู ุงูุนููู ูููุชุงููู Cุ", "o": ["ุฃุณููุฑุจูู", "ุฑูุชูููู", "ููุงุณูู"], "a": "ุฃุณููุฑุจูู"},
            {"q": "ูู ูู ูุฎุชุฑุน ุงูุฑุงุฏููุ", "o": ["ูุงุฑูููู", "ุฅุฏูุณูู", "ุจูู"], "a": "ูุงุฑูููู"},
            {"q": "ูุง ูู ุฃุนูู ูุญูุท ูู ุงูุนุงููุ", "o": ["ุงููุงุฏุฆ", "ุงูุฃุทูุณู", "ุงูููุฏู"], "a": "ุงููุงุฏุฆ"},
            {"q": "ูู ุฃู ุนุงู ุงูุชูุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุซุงููุฉุ", "o": ["1945", "1939", "1950"], "a": "1945"},
            {"q": "ูุง ูู ุฃูุจุฑ ูููุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", "o": ["ุงููุดุชุฑู", "ุฒุญู", "ุงูุฃุฑุถ"], "a": "ุงููุดุชุฑู"},
            {"q": "ูุง ูู ุงูุนุถู ุงููุณุคูู ุนู ุชูุงุฒู ุงูุฌุณูุ", "o": ["ุงูุฃุฐู ุงูุฏุงุฎููุฉ", "ุงูุฏูุงุบ", "ุงูุนูู"], "a": "ุงูุฃุฐู ุงูุฏุงุฎููุฉ"}
        ]
    }

    PRIZES = [0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 600, 700, 800, 900, 1000]
    active_games = {}

    @bot.message_handler(func=lambda m: m.text == "ุงุฑุจุญ")
    def start_game(m):
        uid = m.from_user.id
        session_qs = random.sample(QUESTIONS_DB["easy"], 5) + \
                     random.sample(QUESTIONS_DB["medium"], 5) + \
                     random.sample(QUESTIONS_DB["hard"], 5)
        
        active_games[uid] = {
            "step": 1, 
            "hint_used": False, 
            "questions": session_qs,
            "current_q": session_qs[0]
        }
        send_quiz(m.chat.id, uid, 1, session_qs[0], False)

    def send_quiz(chat_id, uid, step, q_data, hint_used, msg_id=None):
        markup = types.InlineKeyboardMarkup(row_width=2)
        opts = q_data['o']
        
        if hint_used and active_games[uid].get('just_hinted'):
            displayed_opts = [q_data['a'], random.choice([o for o in opts if o != q_data['a']])]
            active_games[uid]['just_hinted'] = False
        else:
            displayed_opts = list(opts)

        btns = [types.InlineKeyboardButton(o, callback_data=f"mw_{o}") for o in displayed_opts]
        random.shuffle(btns)
        markup.add(*btns)
        
        specials = []
        if not hint_used: specials.append(types.InlineKeyboardButton("โ๏ธ ุญุฐู ุฅุฌุงุจุฉ", callback_data="mw_hint"))
        specials.append(types.InlineKeyboardButton("๐ฐ ุงูุณุญุงุจ", callback_data="mw_quit"))
        markup.add(*specials)

        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "      โฏ ูููููููููููุฉ ุงูุฅููุจูุฑุงุทููุฑ โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            f"  ยป ุงููุณูุคุงู : [ {step} / 15 ]\n"
            f"  ยป ุงููุฌูุงุฆูุฒุฉ ุงููููุงุฏูุฉ : {PRIZES[step]} ุฐููุจูุฉ\n\n"
            f"โ [ {q_data['q']} ]"
        )

        if msg_id:
            bot.edit_message_text(text, chat_id, msg_id, reply_markup=markup)
        else:
            bot.send_message(chat_id, text, reply_markup=markup)

    @bot.callback_query_handler(func=lambda call: call.data.startswith("mw_"))
    def handle_win(call):
        uid = call.from_user.id
        if uid not in active_games:
            return bot.answer_callback_query(call.id, "โ ุงูุชูุช ุงูุฌูุณุฉ!")

        game = active_games[uid]
        step = game['step']
        q_data = game['current_q']

        if call.data == "mw_quit":
            prize = PRIZES[step-1]
            # ุฑุจุท ุงูุฐูุจ ุจุงูุฎุฒูุฉ
            db_manager.update_user_gold(uid, prize)
            bot.edit_message_text(f"๐ฐ ูุฑุฑ ุงูุฅูุจุฑุงุทูุฑ {call.from_user.first_name} ุงูุงูุณุญุงุจ!\nโ ุงูุฑุจุญ ุงููุถููู: {prize} ุฐูุจุฉ ุชู ุฅูุฏุงุนูุง ุจุฎุฒูุชู.", call.message.chat.id, call.message.message_id)
            del active_games[uid]
            return

        if call.data == "mw_hint":
            if game['hint_used']: return
            game['hint_used'] = True
            game['just_hinted'] = True
            send_quiz(call.message.chat.id, uid, step, q_data, True, call.message.message_id)
            return

        choice = call.data.replace("mw_", "")
        if choice == q_data['a']:
            if step == 15:
                # ุฌุงุฆุฒุฉ ุงูููููู ุงููุจุฑู
                db_manager.update_user_gold(uid, 1000)
                bot.edit_message_text(f"๐ ููููู! ูุฒุช ุจุงูููููู (1000 ุฐูุจุฉ) ูุง ุฅูุจุฑุงุทูุฑ! ๐", call.message.chat.id, call.message.message_id)
                del active_games[uid]
            else:
                game['step'] += 1
                game['current_q'] = game['questions'][game['step']-1]
                send_quiz(call.message.chat.id, uid, game['step'], game['current_q'], game['hint_used'], call.message.message_id)
        else:
            bot.edit_message_text(f"โ ููุงุณู ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ!\n๐ก ุงูุฅุฌุงุจุฉ ูุงูุช: {q_data['a']}\n๐ ุทุงุฑุช ุนููู ุงูุฌุงุฆุฒุฉ!", call.message.chat.id, call.message.message_id)
            del active_games[uid]
