import random
import time
from telebot import types

# ูุญุงููุฉ ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 0}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # ุงููุงุฆูุฉ ุงููุงููุฉ ูู 45 ุณุคุงูุงู ููุณูุฉ ููุณุชููุงุช
    QUESTIONS_DB = {
        "easy": [
            {"q": "ูุง ูู ููู ุงูุณูุงุก ูู ุงูููุงุฑ ุงูุตุงููุ", "o": ["ุฃุฎุถุฑ", "ุฃุฒุฑู", "ุฃุญูุฑ", "ุฃุณูุฏ"], "a": "ุฃุฒุฑู"},
            {"q": "ูู ุนุฏุฏ ุฃูุงู ุงูุฃุณุจูุนุ", "o": ["5", "6", "7", "8"], "a": "7"},
            {"q": "ูุง ูู ุงูุญููุงู ุงูุฐู ููุนุฑู ุจููุจ ููู ุงูุบุงุจุฉุ", "o": ["ุงูููุฑ", "ุงูุฐุฆุจ", "ุงูุฃุณุฏ", "ุงูููู"], "a": "ุงูุฃุณุฏ"},
            {"q": "ุฃู ูู ูุฐู ุงูููุงูุจ ูู ุงูุฃูุฑุจ ุฅูู ุงูุดูุณุ", "o": ["ุงูุฃุฑุถ", "ุงููุฑูุฎ", "ุนุทุงุฑุฏ", "ุงูุฒูุฑุฉ"], "a": "ุนุทุงุฑุฏ"},
            {"q": "ูู ุนุฏุฏ ุญุฑูู ุงููุบุฉ ุงูุนุฑุจูุฉุ", "o": ["26", "27", "28", "29"], "a": "28"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงูุนุฑุงูุ", "o": ["ุงูุจุตุฑุฉ", "ุจุบุฏุงุฏ", "ุงูููุตู", "ูุฑุจูุงุก"], "a": "ุจุบุฏุงุฏ"},
            {"q": "ุฃู ูู ูุฐู ุงูุฃุนุถุงุก ูุณุคูู ุนู ุถุฎ ุงูุฏูุ", "o": ["ุงูุฑุฆุฉ", "ุงููุจุฏ", "ุงูููุจ", "ุงูุฏูุงุบ"], "a": "ุงูููุจ"},
            {"q": "ูุง ูู ุฃูุจุฑ ูุญูุท ูู ุงูุนุงููุ", "o": ["ุงูุฃุทูุณู", "ุงูููุฏู", "ุงููุงุฏุฆ", "ุงููุชุฌููุฏ"], "a": "ุงููุงุฏุฆ"},
            {"q": "ูู ุนุฏุฏ ุฃุตุงุจุน ูุฏ ุงูุฅูุณุงู ุงููุงุญุฏุฉุ", "o": ["4", "5", "6", "7"], "a": "5"},
            {"q": "ูุง ูู ุตูุช ุงููุทุฉุ", "o": ["ูุจุงุญ", "ุตููู", "ููุงุก", "ุฎูุงุฑ"], "a": "ููุงุก"},
            {"q": "ุฃู ุดูุฑ ูุฃุชู ุจุนุฏ ุดูุฑ ููุงูุฑุ", "o": ["ูุงุฑุณ", "ูุจุฑุงูุฑ", "ุฃุจุฑูู", "ุฏูุณูุจุฑ"], "a": "ูุจุฑุงูุฑ"},
            {"q": "ูุง ูู ููู ุงูุชูุงุญ ุงููุงุถุฌ ุบุงูุจุงูุ", "o": ["ุฃุฒุฑู", "ุฃุญูุฑ", "ุฃุณูุฏ", "ุจููุณุฌู"], "a": "ุฃุญูุฑ"},
            {"q": "ูู ุนุฏุฏ ุณุงุนุงุช ุงููููุ", "o": ["12", "18", "24", "30"], "a": "24"},
            {"q": "ูุง ูู ูุณููุฉ ุงูููู ุงูุชู ุชุทูุฑ ูู ุงูุณูุงุกุ", "o": ["ุงููุทุงุฑ", "ุงูุณูููุฉ", "ุงูุทุงุฆุฑุฉ", "ุงูุณูุงุฑุฉ"], "a": "ุงูุทุงุฆุฑุฉ"},
            {"q": "ุฃู ูู ูุฐู ุงูููุงุฏ ุณุงุฆูุ", "o": ["ุงูุญุฏูุฏ", "ุงูุฎุดุจ", "ุงููุงุก", "ุงูุญุฌุฑ"], "a": "ุงููุงุก"}
        ],
        "medium": [
            {"q": "ูู ูู ูุคูู ูุณุฑุญูุฉ ยซูุงููุชยปุ", "o": ["ุฏูููุฒ", "ุดูุณุจูุฑ", "ุชููุณุชูู", "ุฏูุณุชูููุณูู"], "a": "ุดูุณุจูุฑ"},
            {"q": "ูู ุนุฏุฏ ูุงุฑุงุช ุงูุนุงููุ", "o": ["5", "6", "7", "8"], "a": "7"},
            {"q": "ูุง ูู ุงูุบุงุฒ ุงูุฐู ูุชููุณู ุจูุซุฑุฉุ", "o": ["ุงูุฃูุณุฌูู", "ุงูููุฏุฑูุฌูู", "ููุชุฑูุฌูู", "CO2"], "a": "ุงูุฃูุณุฌูู"},
            {"q": "ูู ุฃู ูุงุฑุฉ ุชูุน ูุตุฑุ", "o": ["ุขุณูุง", "ุฃูุฑูุจุง", "ุฃูุฑูููุง", "ุฃูุฑููุง"], "a": "ุฃูุฑูููุง"},
            {"q": "ูุง ูู ุฃุณุฑุน ุญููุงู ุจุฑูุ", "o": ["ุงูุฃุณุฏ", "ุงูููุฏ", "ุงูุญุตุงู", "ุงูุฐุฆุจ"], "a": "ุงูููุฏ"},
            {"q": "ูู ูู ูุฎุชุฑุน ุงููุตุจุงุญ ุงูููุฑุจุงุฆูุ", "o": ["ูููุชู", "ุฃููุดุชุงูู", "ุฅุฏูุณูู", "ุบุงููููู"], "a": "ุฅุฏูุณูู"},
            {"q": "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", "o": ["ุงูุฃูุงุฒูู", "ุงูููู", "ุงููุฑุงุช", "ุงูุฏุงููุจ"], "a": "ุงูููู"},
            {"q": "ุฃู ุนูู ูุฏุฑุณ ุงูุทูุณุ", "o": ["ุงูุฌููููุฌูุง", "ุงูุฃุญูุงุก", "ุงูุฃุฑุตุงุฏ", "ุงูููุฒูุงุก"], "a": "ุงูุฃุฑุตุงุฏ"},
            {"q": "ูู ุนุฏุฏ ุงููุงุนุจูู ูู ูุฑูู ูุฑุฉ ุงููุฏูุ", "o": ["9", "10", "11", "12"], "a": "11"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงููุงุจุงูุ", "o": ["ุจููู", "ุณููู", "ุทูููู", "ุจุงูููู"], "a": "ุทูููู"},
            {"q": "ุฃู ุนูุตุฑ ุฑูุฒู ุงูููููุงุฆู Oุ", "o": ["ุงูุฐูุจ", "ุงูุฃูุณุฌูู", "ุงูุญุฏูุฏ", "ุงูููุฏุฑูุฌูู"], "a": "ุงูุฃูุณุฌูู"},
            {"q": "ูู ูู ุฃูู ุฅูุณุงู ุตุนุฏ ุฅูู ุงูููุฑุ", "o": ["ุบุงุบุงุฑูู", "ุฃุฑูุณุชุฑููุบ", "ุฃูุฏุฑูู", "ูููููุจูุณ"], "a": "ุฃุฑูุณุชุฑููุบ"},
            {"q": "ูู ุนุฏุฏ ุฃููุงู ููุณ ูุฒุญุ", "o": ["5", "6", "7", "8"], "a": "7"},
            {"q": "ูุง ูู ุงูุนููุฉ ุงูุฑุณููุฉ ููููุงูุงุช ุงููุชุญุฏุฉุ", "o": ["ุงูููุฑู", "ุงูุฌููู", "ุงูุฏููุงุฑ", "ุงููู"], "a": "ุงูุฏููุงุฑ"},
            {"q": "ุฃู ูููุจ ููุนุฑู ุจุงููููุจ ุงูุฃุญูุฑุ", "o": ["ุงููุฑูุฎ", "ุฒุญู", "ุนุทุงุฑุฏ", "ูุจุชูู"], "a": "ุงููุฑูุฎ"}
        ],
        "hard": [
            {"q": "ูู ูู ูุคุณุณ ุนูู ุงูุงุฌุชูุงุนุ", "o": ["ุฃููุงุทูู", "ุงุจู ุฎูุฏูู", "ุฃุฑุณุทู", "ูููุช"], "a": "ุงุจู ุฎูุฏูู"},
            {"q": "ูุง ูู ุงูุนูุตุฑ ุงูุฃูุซุฑ ููุฑุฉ ูู ุงููููุ", "o": ["ุงูุฃูุณุฌูู", "ุงููุฑุจูู", "ุงูููุฏุฑูุฌูู", "ุงููููููู"], "a": "ุงูููุฏุฑูุฌูู"},
            {"q": "ูู ุฃู ุนุงู ุณูุทุช ุจุบุฏุงุฏ ุจูุฏ ุงููุบููุ", "o": ["1200", "1258", "1300", "1400"], "a": "1258"},
            {"q": "ูุง ูู ุฃุตุบุฑ ูููุจ ูู ุงููุฌููุนุฉ ุงูุดูุณูุฉุ", "o": ["ุงููุฑูุฎ", "ุงูุฒูุฑุฉ", "ุนุทุงุฑุฏ", "ุจููุชู"], "a": "ุนุทุงุฑุฏ"},
            {"q": "ูู ูุงู: ยซุฃูุง ุฃููุฑ ุฅุฐู ุฃูุง ููุฌูุฏยปุ", "o": ["ูุงูุท", "ุฏููุงุฑุช", "ููุบู", "ููุชุดู"], "a": "ุฏููุงุฑุช"},
            {"q": "ูู ุนุฏุฏ ุงูุนุธุงู ูู ุฌุณู ุงูุฅูุณุงู ุงูุจุงูุบุ", "o": ["200", "206", "210", "215"], "a": "206"},
            {"q": "ูุง ูู ุฃุทูู ุณูุฑุฉ ูู ุงููุฑุขู ุงููุฑููุ", "o": ["ุงููุณุงุก", "ุขู ุนูุฑุงู", "ุงูุจูุฑุฉ", "ุงูุฃุนุฑุงู"], "a": "ุงูุจูุฑุฉ"},
            {"q": "ุฃู ุฏููุฉ ุงุฎุชุฑุนุช ุงููุฑูุ", "o": ["ุงูููุฏ", "ุงูุตูู", "ูุตุฑ", "ุงููููุงู"], "a": "ุงูุตูู"},
            {"q": "ูุง ูู ุงููุนุฏู ุงูุณุงุฆู ูู ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ ุงูุนุงุฏูุฉุ", "o": ["ุงูุญุฏูุฏ", "ุงูุฒุฆุจู", "ุงูุฃูููููู", "ุงูุฑุตุงุต"], "a": "ุงูุฒุฆุจู"},
            {"q": "ูู ูู ููุชุดู ูุงููู ุงูุฌุงุฐุจูุฉุ", "o": ["ุฃููุดุชุงูู", "ูููุชู", "ุบุงููููู", "ููุจุฑููููุณ"], "a": "ูููุชู"},
            {"q": "ูุง ูู ุนุงุตูุฉ ุงูุฅูุจุฑุงุทูุฑูุฉ ุงูุจูุฒูุทูุฉุ", "o": ["ุฑููุง", "ุฃุซููุง", "ุงููุณุทูุทูููุฉ", "ุฃูุทุงููุฉ"], "a": "ุงููุณุทูุทูููุฉ"},
            {"q": "ุฃู ุจุญุฑ ููุตู ุจูู ุงูุณุนูุฏูุฉ ููุตุฑุ", "o": ["ุงูุฃุณูุฏ", "ุงููุชูุณุท", "ุงูุฃุญูุฑ", "ุจุญุฑ ุงูุนุฑุจ"], "a": "ุงูุฃุญูุฑ"},
            {"q": "ูุง ูู ุงูุงุณู ุงูุนููู ูููุชุงููู Cุ", "o": ["ุฑูุชูููู", "ูุงูุณูููุฑูู", "ุฃุณููุฑุจูู", "ููุงุณูู"], "a": "ุฃุณููุฑุจูู"},
            {"q": "ุฃู ูููุณูู ุฃููุงูู ุงุดุชูุฑ ุจููุฑุฉ ยซููุช ุงูุฅููยปุ", "o": ["ููุบู", "ุดูุจููุงูุฑ", "ููุชุดู", "ูุงูุท"], "a": "ููุชุดู"},
            {"q": "ูุง ูู ุฃูุจุฑ ุนุถู ุฏุงุฎูู ูู ุฌุณู ุงูุฅูุณุงูุ", "o": ["ุงูููุจ", "ุงูุฑุฆุฉ", "ุงููุจุฏ", "ุงูุฏูุงุบ"], "a": "ุงููุจุฏ"}
        ]
    }

    PRIZES = [0, 50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 600, 700, 800, 900, 1000]
    active_games = {}

    @bot.message_handler(func=lambda m: m.text == "ุงุฑุจุญ")
    def start_game(m):
        uid = m.from_user.id
        # ุงุฎุชูุงุฑ 15 ุณุคุงูุงู ุนุดูุงุฆูุงู (5 ูู ูู ูุณุชูู) ูุถูุงู ุงูุชููุน ูู ูู ูุฑุฉ
        session_qs = random.sample(QUESTIONS_DB["easy"], 5) + \
                     random.sample(QUESTIONS_DB["medium"], 5) + \
                     random.sample(QUESTIONS_DB["hard"], 5)
        
        active_games[uid] = {
            "step": 1, 
            "hint_used": False, 
            "questions": session_qs,
            "current_q": session_qs[0]
        }
        send_quiz(m.chat.id, uid, 1, session_qs[0], False)

    def send_quiz(chat_id, uid, step, q_data, hint_used, msg_id=None):
        markup = types.InlineKeyboardMarkup(row_width=2)
        opts = q_data['o']
        
        # ุฅุฐุง ุชู ุชูุนูู ุญุฐู ุฅุฌุงุจุชูู
        if hint_used and active_games[uid].get('just_hinted'):
            correct = q_data['a']
            wrong = [o for o in opts if o != correct]
            displayed_opts = [correct, random.choice(wrong)]
            active_games[uid]['just_hinted'] = False
        else:
            displayed_opts = opts

        btns = [types.InlineKeyboardButton(o, callback_data=f"win_{o}") for o in displayed_opts]
        random.shuffle(btns)
        markup.add(*btns)
        
        special_btns = []
        if not hint_used:
            special_btns.append(types.InlineKeyboardButton("โ๏ธ ุญุฐู ุฅุฌุงุจุชูู", callback_data="win_hint"))
        special_btns.append(types.InlineKeyboardButton("๐ฐ ุงูุณุญุงุจ", callback_data="win_quit"))
        markup.add(*special_btns)

        text = (f"๐๏ธ **ูู ุณูุฑุจุญ ุงูููููู**\n"
                f"โโโโโโโโโโโโโ\n"
                f"ุงูุณุคุงู ุฑูู: {step} ูู 15\n"
                f"ุงูุฌุงุฆุฒุฉ ุงูุญุงููุฉ: {PRIZES[step]} ููุทุฉ\n"
                f"โโโโโโโโโโโโโ\n"
                f"โ {q_data['q']}")

        if msg_id:
            try: bot.edit_message_text(text, chat_id, msg_id, reply_markup=markup, parse_mode="Markdown")
            except: pass
        else:
            bot.send_message(chat_id, text, reply_markup=markup, parse_mode="Markdown")

    @bot.callback_query_handler(func=lambda call: call.data.startswith("win_"))
    def handle_win(call):
        uid = call.from_user.id
        if uid not in active_games:
            return bot.answer_callback_query(call.id, "โ ุงูุชูุช ุงููุนุจุฉ!")

        game = active_games[uid]
        step = game['step']
        q_data = game['current_q']

        if call.data == "win_quit":
            prize = PRIZES[step-1]
            update_user(uid, "balance", get_user(uid)["balance"] + prize)
            bot.edit_message_text(f"๐ฐ ูุฑุฑ ุงูุฅูุจุฑุงุทูุฑ {call.from_user.first_name} ุงูุงูุณุญุงุจ!\nุงูุฑุจุญ: {prize} ููุทุฉ.", call.message.chat.id, call.message.message_id)
            del active_games[uid]
            return

        if call.data == "win_hint":
            if game['hint_used']: return
            game['hint_used'] = True
            game['just_hinted'] = True
            send_quiz(call.message.chat.id, uid, step, q_data, True, call.message.message_id)
            return

        choice = call.data.replace("win_", "")
        if choice == q_data['a']:
            if step == 15:
                update_user(uid, "balance", get_user(uid)["balance"] + 1000)
                bot.edit_message_text(f"๐ ููููู! ูุฒุช ุจุงูููููู (1000 ููุทุฉ) ูุง ุจุทู! ๐", call.message.chat.id, call.message.message_id)
                del active_games[uid]
            else:
                game['step'] += 1
                game['current_q'] = game['questions'][game['step']-1]
                send_quiz(call.message.chat.id, uid, game['step'], game['current_q'], game['hint_used'], call.message.message_id)
        else:
            bot.edit_message_text(f"โ ุฎุทุฃ! ุงูุฅุฌุงุจุฉ ูู: {q_data['a']}\nุฎุณุฑุช ูู ุดูุก!", call.message.chat.id, call.message.message_id)
            del active_games[uid]
            time.sleep(7)
            try: bot.delete_message(call.message.chat.id, call.message.message_id)
            except: pass
