import random
from telebot import types
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 0}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # ูุงุฆูุฉ ุงูู 150 ูููุฉ (ูููุนุฉ ูุนุดูุงุฆูุฉ)
    WORDS_DB = [
        "ุณูููู", "ููุจููุชุฑ", "ูุฏุฑุณุฉ", "ุชููุฌุฑุงู", "ุฃุณุฏ", "ููุณุทูู", "ุงูุนุฑุงู", "ูุตุฑ", "ุจุฑุชูุงู", "ุณูุงุฑุฉ",
        "ุทุงุฆุฑุฉ", "ูุชุงุจ", "ุชููุงุฒ", "ุฑูุถุงู", "ูููุฉ", "ููุฒ", "ุชูุงุญ", "ุนูุจ", "ูุงูุฌู", "ุฎูุฎ",
        "ุจุทูุฎ", "ูุฑุงููุฉ", "ูุฑุฒ", "ููููู", "ุฌูุงูุฉ", "ุงูุงูุงุณ", "ูุดูุด", "ุชูู", "ุฒูุชูู", "ุฑูุงู",
        "ุณูุฑูุง", "ูุจูุงู", "ุงูุงุฑุฏู", "ุงููููุช", "ุงูุจุญุฑูู", "ูุทุฑ", "ุงูุงูุงุฑุงุช", "ุนูุงู", "ุงูููู", "ุงููุบุฑุจ",
        "ุชููุณ", "ุงูุฌุฒุงุฆุฑ", "ููุจูุง", "ุงูุณูุฏุงู", "ุงูุตููุงู", "ุจุบุฏุงุฏ", "ุงููุฏุณ", "ุฏูุดู", "ุจูุฑูุช", "ุนูุงู",
        "ุงูููุงูุฉ", "ุงูุฏูุญุฉ", "ูุณูุท", "ุตูุนุงุก", "ุงูุฑุจุงุท", "ุชููุณ", "ุงูุฌุฒุงุฆุฑ", "ุทุฑุงุจูุณ", "ุงูุฎุฑุทูู", "ููุฑูุจู",
        "ููุฏู", "ุจุงุฑูุณ", "ุฑููุง", "ูุฏุฑูุฏ", "ุจุฑููู", "ุทูููู", "ุจููู", "ุณููู", "ููุณูู", "ูุงุดูุทู",
        "ููุฑ", "ููุฏ", "ุฐุฆุจ", "ุซุนูุจ", "ุฏุจ", "ุฒุฑุงูุฉ", "ููู", "ุญุตุงู", "ุฌูู", "ุจูุฑุฉ",
        "ุฎุฑูู", "ูุงุนุฒ", "ุงุฑูุจ", "ุณูุฌุงุจ", "ูุฑุฏ", "ุชูุณุงุญ", "ุซุนุจุงู", "ุณูุญูุงุฉ", "ุถูุฏุน", "ุนูุฑุจ",
        "ูุณุฑ", "ุตูุฑ", "ุจููุฉ", "ุญูุงูุฉ", "ุนุตููุฑ", "ุจุทุฉ", "ุฏุฌุงุฌุฉ", "ุทุงููุณ", "ุจุทุฑูู", "ูุนุงูุฉ",
        "ุทุงููุฉ", "ูุฑุณู", "ุณุฑูุฑ", "ุฏููุงุจ", "ูุงูุฐุฉ", "ุจุงุจ", "ููุชุงุญ", "ููู", "ุฏูุชุฑ", "ูุณุทุฑุฉ",
        "ููุญุงุฉ", "ุญููุจุฉ", "ุณุงุนุฉ", "ูุงุชู", "ุดุงุญู", "ุณูุงุนุฉ", "ูุงููุฑุง", "ูุฐูุงุน", "ูุตุจุงุญ", "ุซูุงุฌุฉ",
        "ูุฑู", "ููุนูุฉ", "ุดููุฉ", "ุณููู", "ุทุจู", "ููุจ", "ุงุจุฑูู", "ููุดูุฉ", "ุตุงุจูู", "ูุฑุขุฉ",
        "ููุงุจุณ", "ูููุต", "ุจูุทุงู", "ูุณุชุงู", "ุญุฐุงุก", "ุฌูุฑุจ", "ูุจุนุฉ", "ูุธุงุฑุฉ", "ุฎุงุชู", "ุณูุงุฑ",
        "ุฐูุจ", "ูุถุฉ", "ุญุฏูุฏ", "ูุญุงุณ", "ุงููุงุณ", "ุจุญุฑ", "ููุฑ", "ุฌุจู", "ุบุงุจุฉ", "ุตุญุฑุงุก",
        "ููุฑ", "ุดูุณ", "ูุฌูู", "ูููุจ", "ุณูุงุก", "ุณุญุงุจ", "ูุทุฑ", "ุซูุฌ", "ุฑุนุฏ", "ุจุฑู"
    ]

    active_puzzles = {}

    @bot.message_handler(func=lambda m: m.text == "ููู")
    def start_letters(m):
        chat_id = m.chat.id
        word = random.choice(WORDS_DB)
        
        # ุชูููู ุงููููุฉ ูุจุนุซุฑุฉ ุงูุญุฑูู
        letters = list(word)
        random.shuffle(letters)
        shuffled = " - ".join(letters)
        
        active_puzzles[chat_id] = {"word": word, "prize": 20}
        
        text = (f"๐น ููุนูุจูุฉ : ููููู ๐น\n\n"
                f"ุงููููุฉ : [ {shuffled} ]\n\n"
                f"๐ฐ ุงูุฌุงุฆุฒุฉ : 20 ููุทุฉ\n"
                f"ุฃุฑุณู ุงูุญู ุงูุตุญูุญ ุงูุขู!")
        
        bot.send_message(chat_id, text)

    @bot.message_handler(func=lambda m: m.chat.id in active_puzzles)
    def check_letters(m):
        chat_id = m.chat.id
        game_data = active_puzzles[chat_id]
        
        # ุงูุชุฃูุฏ ูู ูุทุงุจูุฉ ุงูุญู ูููููุฉ ุงููุฎุชุงุฑุฉ
        if m.text == game_data['word']:
            uid = m.from_user.id
            prize = game_data['prize']
            
            update_user(uid, "balance", get_user(uid)["balance"] + prize)
            
            bot.reply_to(m, f"โ ููู ูุง ุจุทู! ุฅุฌุงุจุฉ ุตุญูุญุฉ.\nูุจุฑูู ุญุตูุช ุนูู {prize} ููุทุฉ.")
            
            # ูุณุญ ุงููุนุจุฉ ุงูุญุงููุฉ ูู ุงูุฐุงูุฑุฉ ููุณูุงุญ ุจุฌููุฉ ุฌุฏูุฏุฉ
            del active_puzzles[chat_id]
