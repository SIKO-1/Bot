import random
from telebot import types
from db_manager import get_user, update_user

def register_handlers(bot):
    
    # ุงููุงุฆูุฉ ุงููุงููุฉ ูู 50 ุณุคุงู ูุน ูุณุชููุงุช ุงูุตุนูุจุฉ
    QUIZ_DATA = [
        {"q": "ูุง ุงุณู ุงููุจู ุงูุฐู ุงุจุชูุนู ุงูุญูุชุ", "opts": ["ููุณู", "ูููุณ", "ููุญ"], "a": "ูููุณ", "lv": 1},
        {"q": "ูู ูุชุจ ูุชุงุจ 'ุงูุฌูููุฑูุฉ'ุ", "opts": ["ุฃุฑุณุทู", "ุฃููุงุทูู", "ุณูุฑุงุท"], "a": "ุฃููุงุทูู", "lv": 2},
        {"q": "ูุชู ููุนุช ุงูุซูุฑุฉ ุงููุฑูุณูุฉุ", "opts": ["1789", "1776", "1804"], "a": "1789", "lv": 3},
        {"q": "ูุง ูู ุฃุทูู ููุฑ ูู ุงูุนุงููุ", "opts": ["ุงูุฃูุงุฒูู", "ุงูููู", "ุงููุณูุณูุจู"], "a": "ุงูููู", "lv": 1},
        {"q": "ุฃู ุฏูู ูุนุชุจุฑ ุงููุฑุขู ูุชุงุจู ุงูููุฏุณุ", "opts": ["ุงููููุฏูุฉ", "ุงูุฅุณูุงู", "ุงููุณูุญูุฉ"], "a": "ุงูุฅุณูุงู", "lv": 1},
        {"q": "ูู ูุงู 'ุงุนุฑู ููุณู'ุ", "opts": ["ุณูุฑุงุท", "ุฃููุงุทูู", "ุฃุฑุณุทู"], "a": "ุณูุฑุงุท", "lv": 2},
        {"q": "ูู ุฃู ุณูุฉ ุชู ุฅุนูุงู ุงุณุชููุงู ุงูููุงูุงุช ุงููุชุญุฏุฉุ", "opts": ["1776", "1789", "1800"], "a": "1776", "lv": 2},
        {"q": "ูุง ูู ุงููููุจ ุงููุนุฑูู ุจุงููููุจ ุงูุฃุญูุฑุ", "opts": ["ุงููุฑูุฎ", "ุงูุฒูุฑุฉ", "ุนุทุงุฑุฏ"], "a": "ุงููุฑูุฎ", "lv": 1},
        {"q": "ูู ูู ุฃูู ุฎูููุฉ ูู ุงูุฅุณูุงูุ", "opts": ["ุนูู", "ุฃุจู ุจูุฑ ุงูุตุฏูู", "ุนูุฑ"], "a": "ุฃุจู ุจูุฑ ุงูุตุฏูู", "lv": 1},
        {"q": "ูุง ูู ุงูููุณูุฉ ุงูุชู ุชููู ุฃู ุงูุณุนุงุฏุฉ ุงููุฏู ุงูุฃุณููุ", "opts": ["ุงูุฑูุงููุฉ", "ุงูุฃุจูููุฑูุฉ", "ุงููุซุงููุฉ"], "a": "ุงูุฃุจูููุฑูุฉ", "lv": 3},
        {"q": "ูุชู ุงูุชูุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุซุงููุฉุ", "opts": ["1940", "1945", "1950"], "a": "1945", "lv": 2},
        {"q": "ูู ูู ูุคุณุณ ุนูู ุงูููุทูุ", "opts": ["ุฃููุงุทูู", "ุฃุฑุณุทู", "ุณูุฑุงุท"], "a": "ุฃุฑุณุทู", "lv": 2},
        {"q": "ุฃู ุฏููุฉ ุชุนุชุจุฑ ููุฏ ุงูุญุถุงุฑุฉุ", "opts": ["ูุตุฑ", "ุงููููุงู", "ุงูุตูู"], "a": "ูุตุฑ", "lv": 1},
        {"q": "ูุง ูู ุฃุตุบุฑ ุนุธู ูู ุฌุณู ุงูุฅูุณุงูุ", "opts": ["ุนุธู ุงูุฑูุจุฉ", "ุงูุฑูุงุจ", "ุงูุชุฑููุฉ"], "a": "ุงูุฑูุงุจ", "lv": 2},
        {"q": "ูู ุงูุฅุณูุงูุ ูู ุนุฏุฏ ุฑูุนุงุช ุตูุงุฉ ุงููุฌุฑุ", "opts": ["2", "4", "3"], "a": "2", "lv": 1},
        {"q": "ูู ูุงู 'ุฃูุง ุฃููุฑ ุฅุฐู ุฃูุง ููุฌูุฏ'ุ", "opts": ["ุฏููุงุฑุช", "ููุชุดู", "ููุฌู"], "a": "ุฏููุงุฑุช", "lv": 2},
        {"q": "ูุชู ุจุฏุฃุช ุงูุซูุฑุฉ ุงูุตูุงุนูุฉุ", "opts": ["ุงููุฑู 18", "ุงููุฑู 17", "ุงููุฑู 19"], "a": "ุงููุฑู 18", "lv": 2},
        {"q": "ูุง ูู ุนุงุตูุฉ ุงููุงุจุงูุ", "opts": ["ูููุชู", "ุทูููู", "ุฃูุณุงูุง"], "a": "ุทูููู", "lv": 1},
        {"q": "ูู ูู ูุคุณุณ ุงูุฏููุฉ ุงูุนุจุงุณูุฉุ", "opts": ["ุฃุจู ุฌุนูุฑ ุงูููุตูุฑ", "ูุงุฑูู ุงูุฑุดูุฏ", "ูุญูุฏ ุจู ุนุจุฏ ุงููู"], "a": "ุฃุจู ุฌุนูุฑ ุงูููุตูุฑ", "lv": 2},
        {"q": "ูุง ูู ุงููุฏุฑุณุฉ ุงูููุณููุฉ ุงูุชู ุชูุฏูุฑ ุงูุนููุ", "opts": ["ุงูุฑูุงููุฉ", "ุงูุฃุจูููุฑูุฉ", "ุงูููุฌููุฉ"], "a": "ุงูุฑูุงููุฉ", "lv": 3},
        {"q": "ูู ุฃูู ูุฒู ุงููุฑุขูุ", "opts": ["ุงูุตุญุงุจุฉ", "ูู ุงููู ุนูู ูุญูุฏ", "ุงูุฃูุจูุงุก"], "a": "ูู ุงููู ุนูู ูุญูุฏ", "lv": 1},
        {"q": "ูุง ูู ุงููุงุฑุฉ ุงูุฃูุซุฑ ุณูุงููุงุ", "opts": ["ุขุณูุง", "ุฅูุฑูููุง", "ุฃูุฑูุจุง"], "a": "ุขุณูุง", "lv": 1},
        {"q": "ูู ูู ุฃูู ุฑุฆูุณ ููููุงูุงุช ุงููุชุญุฏุฉุ", "opts": ["ุฌููุฑุณูู", "ุฌูุฑุฌ ูุงุดูุทู", "ูููููู"], "a": "ุฌูุฑุฌ ูุงุดูุทู", "lv": 2},
        {"q": "ุฃู ูู ูุฐู ุงููุนุงุฏู ุฃุซูู ูุซุงูุฉุ", "opts": ["ุงูุฐูุจ", "ุงูุญุฏูุฏ", "ุงููุญุงุณ"], "a": "ุงูุฐูุจ", "lv": 2},
        {"q": "ูุง ุงุณู ุงููุนุฑูุฉ ุงูุชู ูุงุฏูุง ุฎุงูุฏ ุถุฏ ุงูุฑููุ", "opts": ["ุงููุฑููู", "ุงููุงุฏุณูุฉ", "ุญุทูู"], "a": "ุงููุฑููู", "lv": 2},
        {"q": "ูู ูุงู 'ุงูุญูุงุฉ ุจูุง ุชูููุฑ ูุง ุชุณุชุญู ุงูุนูุด'ุ", "opts": ["ุณูุฑุงุท", "ุฃููุงุทูู", "ุฃุฑุณุทู"], "a": "ุณูุฑุงุท", "lv": 3},
        {"q": "ูุชู ุงูุชุดูุช ูุงุฑุฉ ุฃูุฑููุงุ", "opts": ["1492", "1500", "1482"], "a": "1492", "lv": 2},
        {"q": "ูุง ูู ุงููููุจ ุงูุฃูุฑุจ ููุดูุณุ", "opts": ["ุงูุฒูุฑุฉ", "ุนุทุงุฑุฏ", "ุงููุฑูุฎ"], "a": "ุนุทุงุฑุฏ", "lv": 1},
        {"q": "ูู ูู ุงูุฎูููุฉ ุงูุฐู ุจูู ูุณุฌุฏ ุงูุฌุงูุน ุจุฏูุดูุ", "opts": ["ุนูุฑ ุจู ุนุจุฏุงูุนุฒูุฒ", "ุงููููุฏ ุจู ุนุจุฏ ุงูููู", "ุงูููุตูุฑ"], "a": "ุงููููุฏ ุจู ุนุจุฏ ุงูููู", "lv": 2},
        {"q": "ูุง ูู ุงูููุณูุฉ ุงูุชู ุชุฑู ุฃู ูู ุดูุก ูุณุจูุ", "opts": ["ุงููุณุจูุฉ", "ุงูุฑูุงููุฉ", "ุงููุซุงููุฉ"], "a": "ุงููุณุจูุฉ", "lv": 3},
        {"q": "ูู ุนุฏุฏ ุณูุฑ ุงููุฑุขู ุงููุฑููุ", "opts": ["114", "113", "110"], "a": "114", "lv": 1},
        {"q": "ุฃู ุฏููุฉ ุตูุนุช ุฃูู ุทุงุฆุฑุฉุ", "opts": ["ูุฑูุณุง", "ุงูููุงูุงุช ุงููุชุญุฏุฉ", "ุฃููุงููุง"], "a": "ุงูููุงูุงุช ุงููุชุญุฏุฉ", "lv": 2},
        {"q": "ูู ูู ุงูููู ุงููุฑุนููู ุงูุฐู ุจูู ุงููุฑู ุงูุฃูุจุฑุ", "opts": ["ุฑูุณูุณ", "ุฎููู", "ุชูุช ุนูุฎ ุขููู"], "a": "ุฎููู", "lv": 1},
        {"q": "ูุง ูู ุฃุตุบุฑ ูููุจ ูู ุงููุธุงู ุงูุดูุณูุ", "opts": ["ุนุทุงุฑุฏ", "ุงูุฒูุฑุฉ", "ุงููุฑูุฎ"], "a": "ุนุทุงุฑุฏ", "lv": 1},
        {"q": "ูู ูู ูุคุณุณ ุงููุฏุฑุณุฉ ุงูุฑูุงููุฉุ", "opts": ["ุฃุจูููุฑ", "ุฒูููู", "ุฏููุงุฑุช"], "a": "ุฒูููู", "lv": 3},
        {"q": "ูุชู ุจุฏุฃุช ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุฃูููุ", "opts": ["1912", "1914", "1918"], "a": "1914", "lv": 2},
        {"q": "ูู ูุงู 'ุงูุญุฑูุฉ ูู ุงูุญู ูู ููู ูุง'ุ", "opts": ["ุณุงุฑุชุฑ", "ููุชุดู", "ุฑูุณู"], "a": "ุณุงุฑุชุฑ", "lv": 3},
        {"q": "ูุง ูู ุนุงุตูุฉ ุงูููุฏุ", "opts": ["ูููุฏููู", "ูููุจุงู", "ูููุชุง"], "a": "ูููุฏููู", "lv": 1},
        {"q": "ูู ุงูุตุญุงุจู ุงููููุจ ุจุณูู ุงููู ุงููุณูููุ", "opts": ["ุนูู", "ุฎุงูุฏ ุจู ุงููููุฏ", "ุณุนุฏ"], "a": "ุฎุงูุฏ ุจู ุงููููุฏ", "lv": 1},
        {"q": "ุฃู ูุฏุฑุณุฉ ุชุคูู ุจุชูุงุฒู ุงูุนุงุทูุฉ ูุงูุนููุ", "opts": ["ุงูุฃุจูููุฑูุฉ", "ุงูุฑูุงููุฉ", "ุงูููุฌููุฉ"], "a": "ุงูุฃุจูููุฑูุฉ", "lv": 3},
        {"q": "ูู ุนุฏุฏ ุฑูุนุงุช ุตูุงุฉ ุงูุธูุฑุ", "opts": ["4", "2", "3"], "a": "4", "lv": 1},
        {"q": "ูู ูุชุจ ูุชุงุจ 'ุชุงุฑูุฎ ุงูุฃูู ูุงููููู'ุ", "opts": ["ุงูุทุจุฑู", "ุงุจู ุฎูุฏูู", "ุงูุฌุงุญุธ"], "a": "ุงูุทุจุฑู", "lv": 2},
        {"q": "ุฃู ุฏููุฉ ูู ุชุดุงุฑู ูู ุงูุญุฑุจ ุงูุนุงูููุฉ ุงูุซุงููุฉุ", "opts": ["ุณููุณุฑุง", "ุฃููุงููุง", "ุงููุงุจุงู"], "a": "ุณููุณุฑุง", "lv": 2},
        {"q": "ูุง ูู ูุบุฉ ุงูููุณูุฉ ุงูููุงุณูููุฉุ", "opts": ["ุงููููุงููุฉ", "ุงููุงุชูููุฉ", "ุงูุนุฑุจูุฉ"], "a": "ุงููููุงููุฉ", "lv": 2},
        {"q": "ูู ูู ุงูุฎูููุฉ ุงูุฑุงุดุฏ ุงูุซุงููุ", "opts": ["ุฃุจู ุจูุฑ", "ุนูุฑ ุจู ุงูุฎุทุงุจ", "ุนูู"], "a": "ุนูุฑ ุจู ุงูุฎุทุงุจ", "lv": 1},
        {"q": "ูุง ูู ุฃุทูู ููุฑ ูู ุขุณูุงุ", "opts": ["ุงููุงูุบุชุณู", "ุงูููู", "ุงูุฃูุงุฒูู"], "a": "ุงููุงูุบุชุณู", "lv": 2},
        {"q": "ูู ูู ูุคุณุณ ุงูุฏููุฉ ุงููุงุทููุฉุ", "opts": ["ุนุจุฏ ุงููู ุงูููุฏู", "ุงูุญุณู ุงูุจุตุฑู", "ุงููุงุฑูู"], "a": "ุนุจุฏ ุงููู ุงูููุฏู", "lv": 3},
        {"q": "ูู ูุงู 'ุงููุฌูุฏ ูุณุจู ุงููุงููุฉ'ุ", "opts": ["ููุฌู", "ุณุงุฑุชุฑ", "ุฏููุงุฑุช"], "a": "ุณุงุฑุชุฑ", "lv": 3},
        {"q": "ุฃู ูู ูุฐู ููุณ ุฑููุงู ูู ุฃุฑูุงู ุงูุฅุณูุงูุ", "opts": ["ุงูุตูุงุฉ", "ุงูุตูุงู", "ุงูุฐูุฑ"], "a": "ุงูุงูุฐูุฑ", "lv": 1},
        {"q": "ูุง ูู ุงูุจุญุฑ ุงูุฐู ููุตู ุฃูุฑูุจุง ุนู ุฃูุฑูููุงุ", "opts": ["ุงูุฃุญูุฑ", "ุงููุชูุณุท", "ุงูุฃุณูุฏ"], "a": "ุงููุชูุณุท", "lv": 1}
    ]

    @bot.message_handler(func=lambda m: m.text in ["ุณ", "ุณุคุงู"])
    def start_quiz(m):
        q_item = random.choice(QUIZ_DATA)
        
        levels = {1: "๐ข ุณูู", 2: "๐ก ูุชูุณุท", 3: "๐ด ุตุนุจ"}
        prize = {1: 100, 2: 200, 3: 300}
        
        difficulty = levels[q_item['lv']]
        reward = prize[q_item['lv']]
        
        text = (f"๐ก๏ธ **ุชุญุฏู ุงูุฅูุจุฑุงุทูุฑูุฉ**\n"
                f"ุงููุณุชูู: {difficulty}\n"
                f"ุงูุฌุงุฆุฒุฉ: {reward} ููุทุฉ ๐ฐ\n"
                f"ุงูุฎุตู: 50 ููุทุฉ ๐ป\n\n"
                f"โ **{q_item['q']}**")
        
        markup = types.InlineKeyboardMarkup(row_width=2)
        btns = [types.InlineKeyboardButton(opt, callback_data=f"qz_{q_item['lv']}_{opt}_{q_item['a']}") for opt in q_item['opts']]
        
        # ุฒุฑ ุงููุณุงุนุฏุฉ
        hint_btn = types.InlineKeyboardButton("๐ก ุญุฐู ุฎูุงุฑ (-50ู)", callback_data=f"qzhint_{q_item['a']}")
        
        random.shuffle(btns)
        markup.add(*btns)
        markup.add(hint_btn)
        
        bot.send_message(m.chat.id, text, reply_markup=markup, parse_mode="Markdown")

    @bot.callback_query_handler(func=lambda call: call.data.startswith(("qz_", "qzhint_")))
    def handle_quiz_callback(call):
        uid = call.from_user.id
        user_bal = get_user(uid)["balance"]

        if call.data.startswith("qzhint_"):
            if user_bal < 50:
                return bot.answer_callback_query(call.id, "โ ุฑุตูุฏู ูุง ูููู!", show_alert=True)
            update_user(uid, "balance", user_bal - 50)
            return bot.answer_callback_query(call.id, "โ ุชู ุฎุตู 50 ููุทุฉ. ุงูุฌูุงุจ ุงูุตุญูุญ ูุจุฏุฃ ุจู: " + call.data.split("_")[1][0], show_alert=True)

        # ูุนุงูุฌุฉ ุงูุฅุฌุงุจุฉ
        _, lv, user_choice, correct_answer = call.data.split("_")
        lv = int(lv)
        prize_map = {1: 100, 2: 200, 3: 300}

        if user_choice == correct_answer:
            reward = prize_map[lv]
            update_user(uid, "balance", user_bal + reward)
            bot.edit_message_text(f"โ **ุตุญ!** ูุจุฑูู {reward} ููุทุฉ.\n๐ฐ ุฑุตูุฏู ุงูุขู: {user_bal + reward}", 
                                  call.message.chat.id, call.message.message_id)
        else:
            update_user(uid, "balance", max(0, user_bal - 50))
            bot.edit_message_text(f"โ **ุฎุทุฃ!** ุงูุฌูุงุจ ูู: {correct_answer}\nุชู ุฎุตู 50 ููุทุฉ ๐", 
                                  call.message.chat.id, call.message.message_id)
