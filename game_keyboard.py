import random
import time
from telebot import types

# ูุธุงู ุงูููุงุท ุงููุฑุชุจุท ุจุงูู Volume
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 0}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # ุงููุงุฆูุฉ ุงูููููุฉ (ูููุงุช ุชุญุชุงุฌ ุฃุตุงุจุน ูู ูููุงุฐ)
    KEYBOARD_WORDS = [
        "ูุณุทูุทูููุฉ", "ูุณููููููู ุงููู", "ุงุณุชุณูููุงููููุง", "ูุฃุณูููุงูููู", "ููุณุชุฎููููู",
        "ูุณุชุถุนููู", "ุณูุฌุนู ููู ุงูุฑุญูู ููุฏููุง", "ุฃูุบูุฑู ุงููู ุชุฃูุฑููู", "ูุฃูุฌููุงู ูุฃููู", "ุงููุชุดุงุจูุงุช",
        "ุฃุชุญุงุฌูููู ูู ุงููู", "ูุชูุงุฑูุง ูู ุฃูุฑูู", "ุณููุฒู ุงูุฌูุน ููููููู ุงูุฏุจุฑ", "ุงุณุชูุจุฑูุง ูุงุณุชุนุชูุง", "ูุฃูุณุงูู ุฃููุณูู",
        "ูุณุชูุจุฑูู ุจู ุณุงูุฑูุง", "ููุณุชุฎููููู ูู ุงูุฃุฑุถ", "ุฃูุชุทูุนูู ุฃู ูุคูููุง ููู", "ูุฏูุฏู ุนูููู ุฑุจูู", "ูุฌุนููู ุฎูุงุฆู",
        "ุงูุฅุณููุฏุฑูุฉ", "ูููููุง ุชุณูุง", "ุงูุฅูุจุฑุงุทูุฑูุฉ", "ุงูุงุณุชุนูุงุฑูุฉ", "ุงูููุชุงููุฒูููุง",
        "ุงููุงูุฑูุฒูุฉ", "ุงูุณูููููุฌูุง", "ุงูุฃูุซุฑูุจูููุฌูุง", "ุงูุฅูุฏููููุฌูุงุช", "ุงูุงุณุชุดุฑุงู",
        "ูุชูุงูุถุงุช", "ุงุณุชุญุงูุฉ", "ุงุณุชุฐูุงุฑ", "ุงููุงูุนู", "ููู ุฅุฏุฑุงูู",
        "ุชุดุธูู", "ุงููุณุงุฑุงุช", "ุชููุถุน", "ุชูุงูู", "ุงููุฌูุฏูุฉ",
        "ุงุณุชุจุทุงู", "ูุงูุฑุงุฆูุงุช", "ุงุณุชูุฑุงุก", "ุงุณุชูุจุงุท", "ุชุฏุงุฎูุงุช",
        "ุงููุงูุญุฏูุฏูุฉ", "ุชุดุงุจูุงุช", "ุงุญุชูุงูุงุช", "ููุถููุฉ", "ุนุจุซููุฉ"
    ]

    active_challenges = {}

    @bot.message_handler(func=lambda m: m.text == "ููุจูุฑุฏ")
    def start_keyboard_game(m):
        chat_id = m.chat.id
        word = random.choice(KEYBOARD_WORDS)
        
        active_challenges[chat_id] = {
            "word": word,
            "winner": None,
            "start_time": time.time()
        }
        
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "         โฏ ุชูุญูุฏู ุงููููููุจููุฑุฏ โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            "โก๏ธ ุฃุณุฑุน ูุงุญุฏ ููุชุจ ุงููููุฉ ุงูุชุงููุฉ:\n"
            f"โจ [ `{word}` ] โจ\n\n"
            "๐ฐ ุงููุฌูุงุฆูุฒุฉ : 100 ููููุทูุฉ\n"
        )
        
        bot.send_message(chat_id, text, parse_mode="Markdown")

    @bot.message_handler(func=lambda m: m.chat.id in active_challenges)
    def check_typing_speed(m):
        chat_id = m.chat.id
        challenge = active_challenges[chat_id]
        
        # ุงูุชุฃูุฏ ูู ุตุญุฉ ุงููููุฉ (ุญุฐู ุงููุณุงูุงุช ุงูุฒุงุฆุฏุฉ)
        if m.text.strip() == challenge["word"]:
            # ุงููุงุฆุฒ ุงูุฃูู
            if not challenge["winner"]:
                challenge["winner"] = m.from_user.id
                elapsed_time = round(time.time() - challenge["start_time"], 2)
                
                # ุชุญุฏูุซ ุงูููุงุท
                user_bal = get_user(m.from_user.id).get("balance", 0)
                update_user(m.from_user.id, "balance", user_bal + 100)
                
                win_text = (
                    "โฏ ูุญูุด ุงููููููุจููุฑุฏ ูุตูู โฏ\n"
                    "โโโโโโโโโโโโโโ\n"
                    f"๐ค ุงููููุงุฆูุฒ : {m.from_user.first_name}\n"
                    f"โฑ๏ธ ุงูููููุช : {elapsed_time} ุซูุงููููุฉ\n"
                    "๐ฐ ุงููุฌููุงุฆูุฒ : +100 ููููุทูุฉ"
                )
                bot.reply_to(m, win_text)
            
            # ุงููุชุฃุฎุฑูู (ูุตู ุฌุจูุงุช)
            else:
                slow_replies = [
                    "ุจุฏุฑู ูุง ุจุทู! ุงูููุฒ ูุบูุฑูุ ุฎููู ุฃุณุฑุน ุงููุฑุฉ ุงูุฌุงูุฉ ๐ข",
                    "ูุง ุจุทูุก! ุงููุงุณ ูุงุฒุช ูุงุนุชุฒูุช ูุฃูุช ุชูู ุชูุชุจุ ๐",
                    "ูุถุนูู! ุฃุตุงุจุนู ูุจูููุง ุชุดุญูู ๐ง",
                    "ูุณูู ูููุง ุณุฑูุนุ ูุงุชู ุงููุทุงุฑ ูุง ูุงุจุชู ๐",
                    "ุดููู ุชูุชุจ ุจุตุจุงุน ูุงุญุฏ.. ุตุญุ ๐คก"
                ]
                bot.reply_to(m, random.choice(slow_replies))
                # ุญุฐู ุงูุชุญุฏู ุจุนุฏ ุฃูู ุฑุฏ "ุจุทูุก" ูุถูุงู ุนุฏู ุฅุฒุนุงุฌ ุงูุดุงุช
                del active_challenges[chat_id]
