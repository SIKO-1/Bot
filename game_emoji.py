import random
from telebot import types

# Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· (Volume)
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 1000}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    
    # Ù…Ø®Ø²Ù† Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙƒÙŠ (60 Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù…Ù†Ù‚Ø­)
    common_emojis = {
        "ğŸ": "ØªÙØ§Ø­Ø©", "ğŸ¦": "Ø£Ø³Ø¯", "ğŸš—": "Ø³ÙŠØ§Ø±Ø©", "ğŸ•": "Ø¨ÙŠØªØ²Ø§", "âš½": "ÙƒØ±Ø© Ù‚Ø¯Ù…",
        "ğŸš€": "ØµØ§Ø±ÙˆØ®", "ğŸ’": "Ø§Ù„Ù…Ø§Ø³", "ğŸ¼": "Ø¨Ø§Ù†Ø¯Ø§", "ğŸŒ": "ÙƒÙˆÙƒØ¨ Ø§Ù„Ø§Ø±Ø¶", "ğŸ“": "ÙØ±Ø§ÙˆÙ„Ø©",
        "ğŸŒ": "Ù…ÙˆØ²", "ğŸ‡": "Ø¹Ù†Ø¨", "ğŸ¥¥": "Ø¬ÙˆØ² Ù‡Ù†Ø¯", "ğŸ¥‘": "Ø§ÙÙˆÙƒØ§Ø¯Ùˆ", "ğŸ¥•": "Ø¬Ø²Ø±",
        "ğŸŸ": "Ø¨Ø·Ø§Ø·Ø³", "ğŸ”": "Ù‡Ù…Ø¨Ø±ØºØ±", "Sushi": "Ø³ÙˆØ´ÙŠ", "ğŸ®": "Ø§Ù„Ø¹Ø§Ø¨", "ğŸ¸": "Ø¬ÙŠØªØ§Ø±",
        "ğŸ“š": "ÙƒØªØ§Ø¨", "ğŸ’°": "ÙÙ„ÙˆØ³", "ğŸ”‘": "Ù…ÙØªØ§Ø­", "ğŸ””": "Ø¬Ø±Ø³", "ğŸ": "Ù‡Ø¯ÙŠØ©",
        "ğŸˆ": "Ø¨Ø§Ù„ÙˆÙ†", "ğŸ‘‘": "ØªØ§Ø¬", "âŒš": "Ø³Ø§Ø¹Ø©", "ğŸ“±": "Ù‡Ø§ØªÙ", "ğŸ’»": "ÙƒÙ…Ø¨ÙŠÙˆØªØ±",
        "ğŸ“·": "ÙƒØ§Ù…ÙŠØ±Ø§", "ğŸ¤": "Ù…Ø§ÙŠÙƒ", "ğŸ§": "Ø³Ù…Ø§Ø¹Ø©", "ğŸ•¯ï¸": "Ø´Ù…Ø¹Ø©", "ğŸ›¡ï¸": "Ø¯Ø±Ø¹",
        "âš”ï¸": "Ø³ÙŠÙ", "ğŸ¹": "Ù‚ÙˆØ³", "âš“": "Ù…Ø±Ø³Ø§Ø©", "ğŸš": "Ù‡Ù„ÙŠÙƒÙˆØ¨ØªØ±", "ğŸš‚": "Ù‚Ø·Ø§Ø±",
        "ğŸ›³ï¸": "Ø³ÙÙŠÙ†Ø©", "ğŸš²": "Ø¯Ø±Ø§Ø¬Ø©", "ğŸš¦": "Ø§Ø´Ø§Ø±Ø© Ù…Ø±ÙˆØ±", "ğŸŒˆ": "Ù‚ÙˆØ³ Ù‚Ø²Ø­", "ğŸ”¥": "Ù†Ø§Ø±",
        "â„ï¸": "Ø«Ù„Ø¬", "âš¡": "Ø¨Ø±Ù‚", "â˜”": "Ù…Ø·Ø±", "ğŸ˜": "ÙÙŠÙ„", "ğŸ¦’": "Ø²Ø±Ø§ÙØ©",
        "ğŸ¦‹": "ÙØ±Ø§Ø´Ø©", "ğŸ¦€": "Ø³Ù„Ø·Ø¹ÙˆÙ†", "ğŸ": "Ù†Ø­Ù„Ø©", "ğŸ¦‰": "Ø¨ÙˆÙ…Ø©", "ğŸ™": "Ø§Ø®Ø·Ø¨ÙˆØ·"
    }

    active_emoji_games = {}

    @bot.message_handler(func=lambda m: m.text == "Ø§ÙŠÙ…ÙˆØ¬ÙŠ")
    def start_emoji_game(m):
        chat_id = m.chat.id
        emo, answer = random.choice(list(common_emojis.items()))
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø±Ø§Ø¨Ø· CDN Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠØ§Øª Ø£Ø¨Ù„
        img_url = f"https://emojicdn.elk.sh/{emo}?style=apple"
        active_emoji_games[chat_id] = answer

        caption = (
            "â”â”â”â”â”â”â”â” â— â”â”â”â”â”â”â”â”“\n"
            "         âŒ¯ ØªÙ€Ø­Ù€Ø¯ÙŠ Ø§Ù„Ø¥ÙŠÙ€Ù…Ù€ÙˆØ¬Ù€ÙŠ âŒ¯\n"
            "â”—â”â”â”â”â”â”â” â— â”â”â”â”â”â”â”â”›\n\n"
            "ğŸ” Ù…Ù€Ø§ Ø§Ø³Ù€Ù… Ù‡Ù€Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ€Ù…Ù€ÙˆØ¬Ù€ÙŠ ØŸ\n\n"
            "ğŸ’° Ø§Ù„Ù€Ø¬Ù€Ø§Ø¦Ø²Ø© : 50 Ù†Ù€Ù‚Ù€Ø·Ù€Ø©\n"
        )
        
        try:
            bot.send_photo(chat_id, img_url, caption=caption)
        except:
            # Ø­Ù„ Ø¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ ØªØ¹Ø·Ù„ Ø³ÙŠØ±ÙØ± Ø§Ù„ØµÙˆØ±
            bot.send_message(chat_id, f"ğŸ“¦ [ {emo} ]\n\n{caption}")

    @bot.message_handler(func=lambda m: m.chat.id in active_emoji_games)
    def check_emoji(m):
        chat_id = m.chat.id
        correct_answer = active_emoji_games[chat_id]
        
        if m.text.strip() == correct_answer:
            uid = m.from_user.id
            user_bal = get_user(uid).get("balance", 0)
            update_user(uid, "balance", user_bal + 50)
            
            win_text = (
                "âŒ¯ ØªÙ€Ù… Ø§Ù„Ù€ØªÙ€Ø­Ù€Ù‚Ù€Ù‚ Ù…Ù€Ù† Ø§Ù„Ø¥Ø¬Ù€Ø§Ø¨Ù€Ø© âŒ¯\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                f"ğŸ‘¤ Ø§Ù„Ù€ÙÙ€Ø§Ø¦Ù€Ø² : {m.from_user.first_name}\n"
                f"âœ… Ø§Ù„Ø¥Ø¬Ù€Ø§Ø¨Ø© : {correct_answer}\n"
                "ğŸ’° Ø§Ù„Ù€Ø¬Ù€ÙˆØ§Ø¦Ù€Ø² : +50 Ù†Ù€Ù‚Ù€Ø·Ù€Ø©"
            )
            bot.reply_to(m, win_text)
            del active_emoji_games[chat_id]
