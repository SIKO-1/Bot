import telebot
from telebot import types
from db_manager import get_user, update_user

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù€ 50 Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨
CONFESS_QUESTIONS = [
    "Ù‡Ù„ ØªØ«Ù‚ Ø¨Ù†ÙØ³Ùƒ ÙØ¹Ù„Ù‹Ø§ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† ÙÙ‚Ø¯Ø§Ù† Ø´Ø®Øµ Ù…Ù‚Ø±Ù‘Ø¨ØŸ", "Ù‡Ù„ Ù†Ø¯Ù…Øª ÙŠÙˆÙ…Ù‹Ø§ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø± Ù…Ù‡Ù…ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„Ø¹Ø²Ù„Ø© Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŸ", "Ù‡Ù„ ØªÙ‚ÙˆÙ„ â€œØ£Ù†Ø§ Ø¨Ø®ÙŠØ±â€ ÙˆØ£Ù†Øª Ù„Ø³Øª ÙƒØ°Ù„ÙƒØŸ", "Ù‡Ù„ Ø³Ø§Ù…Ø­Øª Ø´Ø®ØµÙ‹Ø§ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ØŸ",
    "Ù‡Ù„ ØªØ´ØªØ§Ù‚ Ù„Ø´Ø®Øµ Ù„Ø§ ØªØªØ­Ø¯Ø« Ù…Ø¹Ù‡ØŸ", "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ Ù…Ø®ØªÙ„Ù Ø¹Ù† Ù…Ø­ÙŠØ·ÙƒØŸ", "Ù‡Ù„ ÙƒØªÙ…Øª Ù…Ø´Ø§Ø¹Ø±Ùƒ Ø­ØªÙ‰ ØªØ¹Ø¨ØªØŸ",
    "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ØŸ", "Ù‡Ù„ Ù…Ø±Ù‘ Ø¹Ù„ÙŠÙƒ ÙŠÙˆÙ… ØªÙ…Ù†Ù‘ÙŠØª Ù„Ùˆ ÙŠØ®ØªÙÙŠØŸ", "Ù‡Ù„ ØªØ«Ù‚ Ø¨Ø§Ù„Ù†Ø§Ø³ Ø¨Ø³Ø±Ø¹Ø©ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„Ø§Ù‡ØªÙ…Ø§Ù… Ø­ØªÙ‰ Ù„Ùˆ Ø£Ù†ÙƒØ±ØªØŸ", "Ù‡Ù„ ØªØªØ¸Ø§Ù‡Ø± Ø¨Ø§Ù„Ù‚ÙˆØ© Ø£Ù…Ø§Ù… Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ Ù…Ø¸Ù„ÙˆÙ… Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŸ",
    "Ù‡Ù„ Ù…Ø§ Ø²Ø§Ù„ Ø§Ù„Ù…Ø§Ø¶ÙŠ ÙŠØ¤Ù„Ù…ÙƒØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ø£Ù† ØªÙØ®Ø°Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ", "Ù‡Ù„ ØªØ­Ø¨ Ø´Ø®ØµÙ‹Ø§ ÙˆÙ„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø£Ù† ÙŠØ¹Ø±ÙØŸ",
    "Ù‡Ù„ ØªÙƒØ±Ù‡ Ø§Ù„ÙˆØ¯Ø§Ø¹ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ", "Ù‡Ù„ ØªØ¶Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù‚Ø¨Ù„ Ù†ÙØ³Ùƒ ØºØ§Ù„Ø¨Ù‹Ø§ØŸ",
    "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…ØŸ", "Ù‡Ù„ ØªØ®ÙÙŠ Ø¯Ù…ÙˆØ¹Ùƒ Ø¹Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ø£Ù† ØªØ®Ø³Ø± Ù†ÙØ³ÙƒØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„ØµÙ…Øª Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ù…ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ Ø£ÙƒØ¨Ø± Ù…Ù† Ø¹Ù…Ø±ÙƒØŸ", "Ù‡Ù„ Ø³Ø§Ù…Ø­Øª Ù†ÙØ³Ùƒ ÙØ¹Ù„Ù‹Ø§ØŸ",
    "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ ØªØ­ØªØ§Ø¬ Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·ØŸ", "Ù‡Ù„ Ø¬Ø±Ø­Øª Ø´Ø®ØµÙ‹Ø§ ØªØ­Ø¨Ù‡ Ø¯ÙˆÙ† Ù‚ØµØ¯ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙˆØ­Ø¯Ùƒ Ù„ÙƒÙ† ØªÙƒØ±Ù‡ Ø§Ù„Ø´Ø¹ÙˆØ± Ø¨Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ", "Ù‡Ù„ ØªØ«Ù‚ Ø¨Ø´Ø®Øµ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· ÙÙŠ Ø­ÙŠØ§ØªÙƒØŸ",
    "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ ØªØ¹Ø·ÙŠ Ø£ÙƒØ«Ø± Ù…Ù…Ø§ ØªØ£Ø®Ø°ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø£Ù† ØªÙƒÙˆÙ† Ù…Ù†Ø³ÙŠÙ‹Ø§ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù† Ù‚Ù„Ø¨Ùƒ Ù…ØªØ¹Ø¨ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„Ù„ÙŠÙ„ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„Ù†Ù‡Ø§Ø±ØŸ", "Ù‡Ù„ ØªØ¤Ù…Ù† Ø£Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ­Ø¯Ø« Ù„Ø³Ø¨Ø¨ØŸ", "Ù‡Ù„ Ø­Ø§ÙˆÙ„Øª Ø£Ù† ØªØªØºÙŠØ± Ù…Ù† Ø£Ø¬Ù„ Ø´Ø®ØµØŸ",
    "Ù‡Ù„ ØªÙØªÙ‚Ø¯ Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ù†ÙØ³ÙƒØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ Ù‚ÙˆÙŠ Ø±ØºÙ… ÙƒÙ„ Ø´ÙŠØ¡ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø£Ù† ØªÙÙÙ‡Ù… Ø®Ø·Ø£ØŸ",
    "Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ù…Ù† ÙŠØ³Ù…Ø¹Ùƒ ÙÙ‚Ø·ØŸ", "Ù‡Ù„ Ù…Ø±Ø±Øª Ø¨ØªØ¬Ø±Ø¨Ø© ØºÙŠÙ‘Ø±ØªÙƒ Ù„Ù„Ø£Ø¨Ø¯ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ ØªØ³ØªØ­Ù‚ Ø§Ù„Ø£ÙØ¶Ù„ØŸ",
    "Ù‡Ù„ ØªØ­Ø¨ Ù…Ù† ÙŠÙ‡ØªÙ… Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµØºÙŠØ±Ø©ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ù‚ÙˆÙ„ Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù† Ù‚Ù„Ø¨Ùƒ Ø·ÙŠØ¨ Ø£ÙƒØ«Ø± Ù…Ù…Ø§ ÙŠØ¬Ø¨ØŸ",
    "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ Ø´Ø®Øµ Ø¹Ù…ÙŠÙ‚ØŸ", "Ù‡Ù„ ØªØ¤Ù…Ù† Ø£Ù† Ø§Ù„ØµÙ…Øª Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ Ø¬ÙˆØ§Ø¨ØŸ", "Ù‡Ù„ Ù…Ø§ Ø²Ù„Øª ØªØ­Ø§ÙˆÙ„ Ø±ØºÙ… Ø§Ù„ØªØ¹Ø¨ØŸ"
]

def register_handlers(bot):

    @bot.message_handler(func=lambda m: m.text == "Ø§Ø¹ØªØ±Ø§Ù")
    def start_confess(m):
        uid = m.from_user.id
        user_data = get_user(uid)
        # Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† ÙˆØµÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ ÙŠØ¨Ø¯Ø£ Ù…Ù† 0)
        current_q = user_data.get("confess_progress", 0)

        if current_q >= len(CONFESS_QUESTIONS):
            return bot.reply_to(m, "ğŸ† Ù„Ù‚Ø¯ Ø£Ù†Ù‡ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø¹ØªØ±Ø§ÙØ§Øª ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹! Ø£Ù†Øª Ø´Ø®Øµ ØµØ±ÙŠØ­ Ø¬Ø¯Ø§Ù‹.")

        send_question(m.chat.id, uid, current_q, bot)

    def send_question(chat_id, uid, q_index, bot):
        q_text = CONFESS_QUESTIONS[q_index]
        total = len(CONFESS_QUESTIONS)
        
        text = f"ğŸª **ÙƒØ±Ø³ÙŠ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ù** ({q_index + 1}/{total})\n\nÂ« {q_text} Â»"
        
        markup = types.InlineKeyboardMarkup()
        btn_yes = types.InlineKeyboardButton("Ù†Ø¹Ù… âœ…", callback_data=f"cf_yes_{q_index}")
        btn_no = types.InlineKeyboardButton("Ù„Ø£ âŒ", callback_data=f"cf_no_{q_index}")
        markup.add(btn_yes, btn_no)
        
        bot.send_message(chat_id, text, reply_markup=markup, parse_mode="Markdown")

    @bot.callback_query_handler(func=lambda call: call.data.startswith("cf_"))
    def handle_confess(call):
        _, answer, q_index = call.data.split("_")
        q_index = int(q_index)
        uid = call.from_user.id
        
        # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        next_q = q_index + 1
        update_user(uid, "confess_progress", next_q)
        
        if next_q < len(CONFESS_QUESTIONS):
            # Ù…Ø³Ø­ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ©
            bot.edit_message_text(f"ğŸ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø¹ØªØ±Ø§ÙÙƒ Ø±Ù‚Ù… {next_q}.. Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.", 
                                  call.message.chat.id, call.message.message_id)
            send_question(call.message.chat.id, uid, next_q, bot)
        else:
            # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù€ 50 Ø³Ø¤Ø§Ù„
            points = 500
            new_bal = get_user(uid)["balance"] + points
            update_user(uid, "balance", new_bal)
            bot.edit_message_text(f"ğŸŠ **ØªÙ‡Ø§Ù†ÙŠÙ†Ø§!**\n\nÙ„Ù‚Ø¯ ÙƒÙ†Øª Ø´Ø¬Ø§Ø¹Ø§Ù‹ ÙˆØ£Ù†Ù‡ÙŠØª Ø§Ù„Ù€ 50 Ø§Ø¹ØªØ±Ø§ÙØ§Ù‹ Ø¨Ù†Ø¬Ø§Ø­.\nğŸ’° Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ØµØ±Ø§Ø­Ø©: {points} Ù†Ù‚Ø·Ø©!", 
                                  call.message.chat.id, call.message.message_id)

