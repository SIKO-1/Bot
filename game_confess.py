import random
import db_manager
from telebot import types

def register_handlers(bot):

    # ğŸ’  1. Ù„Ø¹Ø¨Ø© ÙƒØ±Ø³ÙŠ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ù (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ø¨Ø£Ø³Ø¦Ù„Ø© Ø£Ù‚ÙˆÙ‰)
    CONFESS_QUESTIONS = [
        "Ù‡Ù„ ØªØ«Ù‚ Ø¨Ù†ÙØ³Ùƒ ÙØ¹Ù„Ù‹Ø§ØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† ÙÙ‚Ø¯Ø§Ù† Ø´Ø®Øµ Ù…Ù‚Ø±Ù‘Ø¨ØŸ", "Ù‡Ù„ Ù†Ø¯Ù…Øª ÙŠÙˆÙ…Ù‹Ø§ Ø¹Ù„Ù‰ Ù‚Ø±Ø§Ø± Ù…Ù‡Ù…ØŸ",
        "Ù‡Ù„ ØªÙ‚ÙˆÙ„ â€œØ£Ù†Ø§ Ø¨Ø®ÙŠØ±â€ ÙˆØ£Ù†Øª Ù„Ø³Øª ÙƒØ°Ù„ÙƒØŸ", "Ù‡Ù„ Ø³Ø§Ù…Ø­Øª Ø´Ø®ØµÙ‹Ø§ Ù„Ø§ ÙŠØ³ØªØ­Ù‚ØŸ", "Ù‡Ù„ ØªØ´ØªØ§Ù‚ Ù„Ø´Ø®Øµ Ù„Ø§ ØªØªØ­Ø¯Ø« Ù…Ø¹Ù‡ØŸ",
        "Ù‡Ù„ ÙƒØªÙ…Øª Ù…Ø´Ø§Ø¹Ø±Ùƒ Ø­ØªÙ‰ ØªØ¹Ø¨ØªØŸ", "Ù‡Ù„ ØªØ®Ø§Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ØŸ", "Ù‡Ù„ ØªØ«Ù‚ Ø¨Ø§Ù„Ù†Ø§Ø³ Ø¨Ø³Ø±Ø¹Ø©ØŸ",
        "Ù‡Ù„ ØªØªØ¸Ø§Ù‡Ø± Ø¨Ø§Ù„Ù‚ÙˆØ© Ø£Ù…Ø§Ù… Ø§Ù„Ø¢Ø®Ø±ÙŠÙ†ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù†Ùƒ Ù…Ø¸Ù„ÙˆÙ… Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ØŸ", "Ù‡Ù„ Ù…Ø§ Ø²Ø§Ù„ Ø§Ù„Ù…Ø§Ø¶ÙŠ ÙŠØ¤Ù„Ù…ÙƒØŸ",
        "Ù‡Ù„ ØªØ®Ø§Ù Ø£Ù† ØªÙØ®Ø°Ù„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ØŸ", "Ù‡Ù„ ØªØ­Ø¨ Ø´Ø®ØµÙ‹Ø§ ÙˆÙ„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø£Ù† ÙŠØ¹Ø±ÙØŸ", "Ù‡Ù„ ØªÙƒØ±Ù‡ Ø§Ù„ÙˆØ¯Ø§Ø¹ØŸ",
        "Ù‡Ù„ ØªØ¶Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù‚Ø¨Ù„ Ù†ÙØ³Ùƒ ØºØ§Ù„Ø¨Ù‹Ø§ØŸ", "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ ØºÙŠØ± Ù…ÙÙ‡ÙˆÙ…ØŸ", "Ù‡Ù„ ØªØ®ÙÙŠ Ø¯Ù…ÙˆØ¹Ùƒ Ø¹Ù† Ø§Ù„Ø¬Ù…ÙŠØ¹ØŸ",
        "Ù‡Ù„ ØªØ­Ø¨ Ø§Ù„ØµÙ…Øª Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ù…ØŸ", "Ù‡Ù„ Ø³Ø§Ù…Ø­Øª Ù†ÙØ³Ùƒ ÙØ¹Ù„Ù‹Ø§ØŸ", "Ù‡Ù„ ØªØ­Ø³ Ø£Ù†Ùƒ ØªØ­ØªØ§Ø¬ Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©ØŸ",
        "Ù‡Ù„ Ø¬Ø±Ø­Øª Ø´Ø®ØµÙ‹Ø§ ØªØ­Ø¨Ù‡ Ø¯ÙˆÙ† Ù‚ØµØ¯ØŸ", "Ù‡Ù„ ØªØ´Ø¹Ø± Ø£Ù† Ù‚Ù„Ø¨Ùƒ Ù…ØªØ¹Ø¨ØŸ", "Ù‡Ù„ ØªØ¤Ù…Ù† Ø£Ù† ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ­Ø¯Ø« Ù„Ø³Ø¨Ø¨ØŸ"
    ]

    @bot.message_handler(func=lambda m: m.text == "Ø§Ø¹ØªØ±Ø§Ù")
    def start_confess(m):
        question = random.choice(CONFESS_QUESTIONS)
        text = (
            "â”â”â”â”â”â”â”â” â— â”â”â”â”â”â”â”â”“\n"
            "         âŒ¯ ÙƒÙ€Ø±Ø³Ù€ÙŠ Ø§Ù„Ø§Ø¹Ù€ØªÙ€Ø±Ø§Ù âŒ¯\n"
            "â”—â”â”â”â”â”â”â” â— â”â”â”â”â”â”â”â”›\n\n"
            f"ğŸ‘¤ Ø¥Ù„Ù€Ù‰ : {m.from_user.first_name}\n\n"
            f"ğŸ’¬ Ø§Ù„Ù€Ø³Ù€Ø¤Ø§Ù„ :\n"
            f"Â« **{question}** Â»\n\n"
            "âš–ï¸ Ø£Ø¬Ù€Ø¨ Ø¨Ù€ÙƒÙ€Ù„ ØµÙ€Ø±Ø§Ø­Ø©.."
        )
        bot.send_message(m.chat.id, text, parse_mode="Markdown")

    # ğŸ›’ 2. Ù…ØªØ¬Ø± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„Ù…Ø·ÙˆØ± (Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©) [cite: 2026-01-02]
    @bot.message_handler(func=lambda m: m.text in ["Ù…ØªØ¬Ø±", "Ø§Ù„Ù…ØªØ¬Ø±"])
    def show_shop(m):
        shop_text = (
            "ğŸ° **Ù…Ù€ØªÙ€Ø¬Ù€Ø± Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠÙ€Ø© Ø§Ù„Ù€Ù…Ù€Ø·Ù€ÙˆÙ‘Ø±** ğŸ°\n"
            "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            "ğŸ›¡ï¸ Ø¯Ø±Ø¹ Ø§Ù„Ø­ØµØ§Ù†Ø© Â» 3000\n"
            "ğŸ“œ Ø¹ÙÙˆ Ø´Ø§Ù…Ù„ Â» 5000\n"
            "ğŸ†” ØªØºÙŠÙŠØ± Ø§Ù„Ù‡ÙˆÙŠØ© Â» 1000\n"
            "ğŸ ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¸ Â» 1000\n"
            "ğŸ’ Ø§Ù„ÙƒÙ†Ø² Â» 1000\n"
            "ğŸ§§ Ø¹ÙŠØ¯ÙŠØ© Â» 200\n"
            "ğŸ“Œ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ© Â» 100\n"
            "ğŸ­ Ø¨Ø§ÙŠÙˆ ØµØ¯ÙŠÙ‚ Â» 1000\n\n"
            "âœ¨ **Ø£ØºØ±Ø§Ø¶ Ù…Ù…ØªØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©:** âœ¨\n"
            "ğŸ‘‘ Ù„Ù‚Ø¨ Ù…Ù„ÙƒÙŠ Â» 1500\n"
            "ğŸš€ Ø·Ø±Ø¯ ÙˆÙ‡Ù…ÙŠ Ù„ØµØ¯ÙŠÙ‚ Â» 2500\n"
            "ğŸ¤– Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª Â» 4500\n"
            "ğŸ”¥ Ù‚ØµÙ Ø¬Ø¨Ù‡Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠ Â» 500\n"
            "ğŸ” ØªÙØªÙŠØ´ Ø³Ø±ÙŠ Â» 1200\n"
            "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            "ğŸ’¡ Ù„Ù„Ø´Ø±Ø§Ø¡: Ø§ÙƒØªØ¨ (Ø´Ø±Ø§Ø¡ + Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶)\n"
            "ğŸ–¼ï¸ Ù„Ø¹Ø±Ø¶ Ù…Ù…ØªÙ„ÙƒØ§ØªÙƒ: Ø§ÙƒØªØ¨ (Ø§Ù„Ù…Ø¹Ø±Ø¶)"
        )
        bot.send_message(m.chat.id, shop_text, parse_mode="Markdown")

    # ğŸ’³ 3. Ù…Ø­Ø±Ùƒ Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ­Ø¯
    @bot.message_handler(func=lambda m: m.text and m.text.startswith("Ø´Ø±Ø§Ø¡ "))
    def buy_process(m):
        user_id = m.from_user.id
        item_name = m.text.replace("Ø´Ø±Ø§Ø¡ ", "").strip()
        
        prices = {
            "Ø¯Ø±Ø¹ Ø§Ù„Ø­ØµØ§Ù†Ø©": 3000, "Ø¹ÙÙˆ Ø´Ø§Ù…Ù„": 5000, "ØªØºÙŠÙŠØ± Ø§Ù„Ù‡ÙˆÙŠØ©": 1000,
            "ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø­Ø¸": 1000, "Ø§Ù„ÙƒÙ†Ø²": 1000, "Ø¹ÙŠØ¯ÙŠØ©": 200,
            "Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø«Ø¨ØªØ©": 100, "Ø¨Ø§ÙŠÙˆ ØµØ¯ÙŠÙ‚": 1000,
            "Ù„Ù‚Ø¨ Ù…Ù„ÙƒÙŠ": 1500, "Ø·Ø±Ø¯ ÙˆÙ‡Ù…ÙŠ Ù„ØµØ¯ÙŠÙ‚": 2500,
            "Ø§Ù„Ø³ÙŠØ·Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª": 4500, "Ù‚ØµÙ Ø¬Ø¨Ù‡Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠ": 500,
            "ØªÙØªÙŠØ´ Ø³Ø±ÙŠ": 1200
        }

        if item_name in prices:
            price = prices[item_name]
            user_gold = db_manager.get_user_gold(user_id)

            if user_gold >= price:
                try:
                    db_manager.update_user_gold(user_id, -price)
                    db_manager.add_item_to_inventory(user_id, item_name)
                    
                    bot.reply_to(m, f"âœ… ØªÙ… Ø´Ø±Ø§Ø¡ **{item_name}** Ø¨Ù†Ø¬Ø§Ø­!\nğŸ’° Ø®ØµÙ…Ù†Ø§ {price} Ø°Ù‡Ø¨Ø©.\nğŸ–¼ï¸ ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹Ù‡Ø§ ÙÙŠ Ù…Ø¹Ø±Ø¶Ùƒ Ø§Ù„Ø®Ø§Øµ.")
                except Exception as e:
                    bot.reply_to(m, f"âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ØŒ ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: {e}")
            else:
                bot.reply_to(m, f"âŒ Ø°Ù‡Ø¨Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ! Ø±ØµÙŠØ¯Ùƒ {user_gold} Ø°Ù‡Ø¨Ø© ÙÙ‚Ø·.")
        else:
            bot.reply_to(m, "âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ØºØ±Ø¶ ØºÙŠØ± Ù…ØªÙˆÙØ± ÙÙŠ Ù…Ø®Ø§Ø²Ù†Ù†Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹.")

    # ğŸ–¼ï¸ 4. Ø§Ù„Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠ
    @bot.message_handler(func=lambda m: m.text == "Ø§Ù„Ù…Ø¹Ø±Ø¶")
    def show_inventory(m):
        user_id = m.from_user.id
        try:
            items = db_manager.get_user_inventory(user_id)
            
            if items and len(items) > 0:
                items_list = "\n".join([f"â€¢ {item}" for item in items])
                text = (
                    f"ğŸ–¼ï¸ **Ù…Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± {m.from_user.first_name}:**\n"
                    "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
                    f"{items_list}\n"
                    "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
                )
                bot.reply_to(m, text, parse_mode="Markdown")
            else:
                bot.reply_to(m, "ğŸ“ª Ø®Ø²Ù†ØªÙƒ ÙØ§Ø±ØºØ©.. Ø§Ù„Ù…ØªØ¬Ø± ÙŠÙ†ØªØ¸Ø±Ùƒ!")
        except Exception as e:
            bot.reply_to(m, f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¹Ø±Ø¶: {e}")
