import random
import db_manager

def register_handlers(bot):
    
    # ğŸ“œ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù„Ø±ØªØ¨ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© (25 Ø±ØªØ¨Ø©)
    RANKS = {
        "Ù…Ø¨ØªØ¯Ø¦": 0, "Ù…ÙƒØ§ÙØ­": 50, "ØµÙŠØ§Ø¯": 150, "Ø¬Ù†Ø¯ÙŠ": 300, "ÙØ§Ø±Ø³": 500,
        "Ù…ØºÙˆØ§Ø±": 800, "Ù‚Ù†Ø§Øµ": 1200, "Ø²Ø¹ÙŠÙ…": 2000, "Ø´ÙŠØ®": 3500, "Ø¨Ø§Ø´Ø§": 5000,
        "Ø³ÙÙŠØ±": 7000, "ÙˆØ²ÙŠØ±": 10000, "Ø­Ø§ÙƒÙ…": 15000, "Ø³Ù„Ø·Ø§Ù†": 20000, "Ù…Ù„Ùƒ": 30000,
        "Ø¯ÙˆÙ‚": 40000, "Ø¨Ø§Ø±ÙˆÙ†": 50000, "ÙƒÙˆÙ†Øª": 60000, "Ù…Ø§Ø±ÙƒÙŠØ²": 75000, "Ø£Ù…ÙŠØ±": 100000,
        "ÙˆÙ„ÙŠ Ø¹Ù‡Ø¯": 150000, "Ø¬Ù†Ø±Ø§Ù„": 250000, "Ù…Ø´ÙŠØ±": 400000, "Ø£Ø³Ø·ÙˆØ±Ø©": 700000, "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±": 9999999
    }

    MOTIVATION = [
        "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØªÙ†Ø§ ØªÙØªØ®Ø± Ø¨ÙˆØ¬ÙˆØ¯ Ø¹Ø¸ÙŠÙ… Ù…Ø«Ù„Ùƒ! ğŸ‘‘",
        "Ø®Ø·ÙˆØ§ØªÙƒ Ø«Ø§Ø¨ØªØ© Ù†Ø­Ùˆ Ø§Ù„Ù‚Ù…Ø©ØŒ Ù„Ø§ Ø£Ø­Ø¯ ÙŠÙˆÙ‚ÙÙƒ! ğŸ”¥",
        "Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠ Ù‚Ø§Ù…ÙˆØ³Ù†Ø§ØŒ ÙˆØ£Ù†Øª Ø§Ù„Ø¯Ù„ÙŠÙ„! âœ¨"
    ]

    # ğŸ’  Ø£Ù…Ø± "Ù…Ø³ØªÙˆÙ‰"
    @bot.message_handler(func=lambda m: m.text in ["Ù…Ø³ØªÙˆÙ‰", "Ù…Ø³ØªÙˆØ§ÙŠ"])
    def my_level(m):
        uid = str(m.from_user.id)
        u = db_manager.get_user(uid)
        lvl, xp, rank = u['level'], u['xp'], u.get('rank', 'Ù…Ø¨ØªØ¯Ø¦')
        diff = (lvl // 50) + 1
        needed = lvl * (10 * diff)
        
        status = (
            "â”â”â”â”â”â”â”â” ğŸ¦… â”â”â”â”â”â”â”â”“\n"
            "       âŒ¯ Ø§Ù„Ù€Ø³Ù€Ø¬Ù€Ù„ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠ âŒ¯\n"
            "â”—â”â”â”â”â”â”â” ğŸ¦… â”â”â”â”â”â”â”â”›\n\n"
            f"ğŸ‘¤ Ø§Ù„Ù€Ù…Ù€ÙˆØ§Ø·Ù€Ù† : {m.from_user.first_name}\n"
            f"ğŸ–ï¸ Ø§Ù„Ù€Ø±ØªØ¨Ù€Ø© Ø§Ù„Ù€Ø­Ù€Ø§Ù„Ù€ÙŠÙ€Ø© : **[{rank}]**\n"
            f"â­ Ø§Ù„Ù€Ù…Ù€Ø³Ù€ØªÙ€ÙˆÙ‰ : {lvl}\n"
            f"ğŸ’  Ø§Ù„Ù€Ø®Ù€Ø¨Ù€Ø±Ø© : {xp}/{needed}\n"
            f"âš–ï¸ Ù…Ù€Ø¹Ù€Ø¯Ù„ Ø§Ù„Ù€ØµÙ€Ø¹Ù€ÙˆØ¨Ù€Ø© : x{diff}\n"
            "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            "âœ¨ Ø·Ù€ÙˆØ¨Ù€Ù‰ Ù„Ù€Ù„Ù€Ø¹Ù€Ø¸Ù€Ù…Ù€Ø§Ø¡ ÙÙ€ÙŠ Ø¯ÙˆÙ„ØªÙ€Ù†Ù€Ø§ âœ¨"
        )
        bot.reply_to(m, status, parse_mode="Markdown")

    # ğŸ“œ Ø£Ù…Ø± "Ø±ØªØ¨"
    @bot.message_handler(func=lambda m: m.text == "Ø±ØªØ¨")
    def list_ranks(m):
        txt = "ğŸ“œ **Ø¯ÙŠÙ€ÙˆØ§Ù† Ø§Ù„Ù€Ù…Ù€Ø±Ø§ØªÙ€Ø¨ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠÙ€Ø©** ğŸ“œ\n"
        txt += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
        # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø±ØªØ¨ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        for i, (name, price) in enumerate(RANKS.items()):
            icon = "ğŸ‘‘" if name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±" else "ğŸ”¹"
            p_txt = "Ø¨Ù‚Ø±Ø§Ø± Ù…Ù„ÙƒÙŠ" if name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±" else f"{price} Ø°Ù‡Ø¨Ø©"
            txt += f"{icon} {name} Â» {p_txt}\n"
            if (i+1) % 5 == 0: txt += "â€”\n"
        txt += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
        txt += "ğŸ’¡ Ù„Ù€Ù„Ù€ØªÙ€Ø±Ù‚Ù€ÙŠÙ€Ø©: (Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© + Ø§Ù„Ø§Ø³Ù…)"
        bot.reply_to(m, txt, parse_mode="Markdown")

    # ğŸ›¡ï¸ Ø£Ù…Ø± "Ø±ØªØ¨ØªÙŠ"
    @bot.message_handler(func=lambda m: m.text == "Ø±ØªØ¨ØªÙŠ")
    def show_rank(m):
        rank = db_manager.get_rank(m.from_user.id)
        bot.reply_to(m, f"ğŸ›¡ï¸ Ù…Ù€Ù‚Ù€Ø§Ù…Ù€Ùƒ Ø§Ù„Ù€Ø­Ù€Ø§Ù„Ù€ÙŠ : **[{rank}]**")

    # ğŸ’° Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±ØªØ¨Ø©
    @bot.message_handler(func=lambda m: m.text and m.text.startswith("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© "))
    def buy_rank(m):
        rank_name = m.text.replace("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© ", "").strip()
        uid = str(m.from_user.id)
        if rank_name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±":
            bot.reply_to(m, "âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡:** Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø±Ø´ØŒ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± ÙˆØ§Ø­Ø¯ Ù„Ø§ Ø´Ø±ÙŠÙƒ Ù„Ù‡!")
            return
        if rank_name in RANKS:
            price = RANKS[rank_name]
            bal = db_manager.get_balance(uid)
            if bal >= price:
                db_manager.update_balance(uid, -price)
                db_manager.set_rank(uid, rank_name)
                bot.reply_to(m, f"ğŸŠ **Ù…Ù€Ø±Ø§Ø³Ù€ÙŠÙ€Ù… Ø§Ù„Ù€ØªÙ€Ù†Ù€ØµÙ€ÙŠÙ€Ø¨!**\nØªÙ€Ù… ØªÙ€Ø±Ù‚Ù€ÙŠÙ€ØªÙ€Ùƒ Ø¥Ù„Ù€Ù‰ Ø±ØªØ¨Ù€Ø©: **[{rank_name}]**")
            else:
                bot.reply_to(m, f"âŒ Ù…Ù€Ø®Ù€Ø²Ù†Ù€Ùƒ Ø§Ù„Ù€Ù…Ù€Ø§Ù„Ù€ÙŠ Ù„Ø§ ÙŠÙ€ÙƒÙ€ÙÙ€ÙŠ! ØªÙ€Ø­Ù€ØªÙ€Ø§Ø¬ {price-bal} Ø°Ù‡Ø¨Ø©.")

    # ğŸ“ˆ Ù†Ø¸Ø§Ù… Ø§Ù„Ø®Ø¨Ø±Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    @bot.message_handler(func=lambda m: True)
    def handle_xp(m):
        if m.text and not m.text.startswith(("/", "!", "#")):
            leveled_up, new_lvl = db_manager.update_xp(m.from_user.id, 5)
            if leveled_up:
                gift = random.randint(1, 500)
                db_manager.update_balance(m.from_user.id, gift)
                bot.reply_to(m, f"ğŸ†™ **ØªÙ€Ø±Ù‚Ù€ÙŠÙ€Ø© Ù…Ù€Ù„Ù€ÙƒÙ€ÙŠÙ€Ø©!** ØµÙ€Ø¹Ù€Ø¯Øª Ù„Ù€Ù„Ù€ÙÙ€Ù„ **{new_lvl}**\nğŸ ÙˆÙ‡Ø¨Ù€Ùƒ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ± **{gift}** Ø°Ù‡Ø¨Ù€Ø©\nğŸ“œ {random.choice(MOTIVATION)}")
