import random
import time
import threading
from telebot import types

def register_handlers(bot):
    
    # ูุงุฆูุฉ ุงูุนููุจุงุช ุงูู 50 ุงูููููุฉ (ุชู ุชูููุญูุง ูุชูุงุณุจ ุงูููุจุฉ)
    PENALTIES_LIST = [
        "ูู ุฃูุง ุบุจู ุจุตูุช ๐๏ธ", "ุงุนุทู ุดุฎุต ูุนูู ุชุญูุฉ ุบุฑูุจุฉ ๐", "ุงุฑุณู ุฅูููุฌู ุบุฑูุจ ูู ุงููุญุงุฏุซุฉ ๐บ",
        "ุงุนูู ูุฌู ูุถุญู ุนุดุฑ ุซูุงูู ุจุตูุช ๐คช", "ุญุงูู ุงูุฑูุต ุนุดุฑูู ุซุงููุฉ ๐", "ุบููู ุฌููุฉ ูุงุญุฏุฉ ุจุตูุช ๐ค",
        "ุบููุถ ุนูููู ูุญุงูู ุงูุฅุดุงุฑุฉ ุนูู ุดูุก ๐", "ููู ุฃุณุฑุงุฑู ุงูุตุบูุฑุฉ ูุตุฏูู ๐คซ", "ุงูุชุจ ูููุฉ (ุฃูุง ูููุฒ) ุนุดุฑ ูุฑุงุช โจ",
        "ุงุนุทู ููุจ ุบุฑูุจ ูุฃุญุฏ ุงููุงุนุจูู ๐ท๏ธ", "ุชูููุฏ ุตูุช ุญููุงู ุจุตูุช ๐ฆ", "ููู ููุชุฉ ุณูุฆุฉ ุจุตูุช ๐",
        "ุงุฑุณู ุตูุฑุฉ ุบุฑูุจุฉ ูู ๐ธ", "ููู ุฌููุฉ ุนูุณ ุดุฎุตูุชู ุจุตูุช ๐ค", "ุงุนูู ุชุญุฏู ุงูุชุนุจูุฑ ุจุฏูู ูููุงุช ุจุตูุช ๐ค",
        "ุงุฎุชุฑ ูุงุนุจ ูููุชุจ ุฌููุฉ ูุถุญูุฉ ุนูู โ๏ธ", "ููู ุฃูุง ุฃุญุจ ุงูุนููุจุงุช ุจุตูุช โค๏ธ", "ุงุฑุณู ุฑุณุงูุฉ ูุถุญูุฉ ููุฌููุนุฉ ุฃุฎุฑู โ๏ธ",
        "ุงูุชุจ ุฃุญุฑู ุนุดูุงุฆูุฉ ุนุดุฑ ุซูุงูู โจ๏ธ", "ูู ูููุฉ ุฃุฎุทุงุก ูุน ูู ุญุฑู ุจุตูุช โ๏ธ", "ุญุงูู ููู ุงูุญุฑูู ุงูุฃุจุฌุฏูุฉ ุจุงูุนูุณ ุจุตูุช ๐ก",
        "ุงุฌูุณ ุตุงูุช ุฏูููุฉ ูุงุญุฏุฉ ๐ถ", "ุงุนุทู ุงุณู ูุณุชุนุงุฑ ุบุฑูุจ ููุงุนุจ ูุนูู ๐ญ", "ุบููุถ ุนูููู ูุฃุดูุฑ ุฅูู ุดูุก ูู ุงูุบุฑูุฉ ๐",
        "ูู ุนุจุงุฑุฉ ุบุฑูุจุฉ ุจุฏูู ุชููู ุฎูุณ ุซูุงูู ุจุตูุช ๐ฃ๏ธ", "ุงุฎุชุฑ ูุงุนุจ ูููููุฏู ุฎูุณ ุนุดุฑุฉ ุซุงููุฉ ุจุตูุช ๐ฅ",
        "ูู ุนุจุงุฑุฉ ูุถุญูุฉ ูู ุงููุญุงุฏุซุฉ ุจุตูุช ๐", "ุงูุชุจ ุฑุณุงูุฉ ุญุจ ุณุงุฎุฑุฉ ูุตุฏูู ๐", "ุงุฑุณู ุตูุฑุฉ ุนุดูุงุฆูุฉ ูุถุญูุฉ ๐ผ๏ธ",
        "ุงูุชุจ ุญุฑู ูุงุญุฏ ูู ุซูุงุซ ุซูุงูู ููุฏุฉ ุนุดุฑ ุซูุงูู โณ", "ุงุบูู ููุทุน ุฃุบููุฉ ุบุฑูุจ ุจุตูุช ๐ต", "ุงุนูู ูุฌู ูุฎูู ุนุดุฑ ุซูุงูู ุจุตูุช ๐น",
        "ุงูุชุจ ูููุฉ (ุฃูุง ุฎุงุฆู) ุฎูุณ ูุฑุงุช ๐จ", "ุงุฎุชุฑ ุดุฎุต ููุตูู ุจูููุฉ ุบุฑูุจุฉ ๐", "ุถุน ุฅูููุฌู ูู ูู ุฑุณุงูุฉ ูุงุฏูุฉ (5 ุฑุณุงุฆู) ๐พ",
        "ุญุงูู ุชุญุฑูู ุฌุณูู ูุซู ุญููุงู ๐", "ูู ุฌููุฉ ุจูุง ุฃู ุญุฑูุฉ ูู ุนุดุฑ ุซูุงูู ุจุตูุช ๐", "ุงูุชุจ ุฑุณุงูุฉ ุจุฃุญุฑู ูุจูุฑุฉ ููุท ๐ฐ๏ธ",
        "ุบููุถ ุนูููู ูุญุงูู ููุณ ุดุฎุต ุจุฌุงูุจู โ", "ุงุฎุชุฑ ูุงุนุจ ููุฌุนู ุงูุฌููุน ูุถุญู ๐คฃ", "ูู ูููุฉ ูุถุญูุฉ ูู ูุฑุฉ ุฃุญุฏ ูุชุญุฏุซ ุจุตูุช ๐ข",
        "ุงุนูู ุชุญุฏู ุงูุชุนุจูุฑ ุจุญุฑูุฉ ุฌุณูู ููุท ๐คธ", "ุงุฎุชุฑ ูุงุนุจ ูููุชุจ ูููุฉ ุบุฑูุจุฉ ุนูู ๐๏ธ", "ุญุงูู ููู ุฌููุฉ ุตุนุจุฉ ุจุณุฑุนุฉ ุซูุงุซ ูุฑุงุช ุจุตูุช ๐",
        "ุงูุชุจ ุฌููุฉ ุบุฑูุจุฉ ุจุฏูู ุญุฑูู ูุนููุฉ ๐ซ", "ุงุฌุนู ุฃุญุฏ ุงููุงุนุจูู ููููุฏู ุฎูุณ ุซูุงูู ุจุตูุช ๐", "ุงุฑุณู ุตูุฑุฉ ุฅูููุฌู ุบุฑูุจุฉ ุฏูู ุชูุณูุฑ ๐",
        "ุงุฐูุฑ ุซูุงุซ ูููุงุช ุนุดูุงุฆูุฉ ูุถุญูุฉ ๐", "ุงุบูู ุขุฎุฑ ูููุฉ ูุงููุง ุงููุงุนุจ ูุจูู ุจุตูุช ๐ถ", "ุงุฎุชุฑ ูุงุนุจ ููููู ูููุฉ ูุถุญูุฉ ุจุตูุชู ุงูุบุฑูุจ ๐๏ธ"
    ]

    active_games = {}

    @bot.message_handler(func=lambda m: m.text == "ุนููุจุงุช")
    def start_penalty_reg(m):
        chat_id = m.chat.id
        if m.chat.type == "private":
            return bot.reply_to(m, "โ ูุฐู ุงููุนุจุฉ ูููุฌููุนุงุช ุงูุฅูุจุฑุงุทูุฑูุฉ ููุท.")

        # ููุน ุชุฏุงุฎู ุงูุฃูุนุงุจ ูู ููุณ ุงููุฌููุนุฉ
        if chat_id in active_games:
            return bot.reply_to(m, "โ๏ธ ุงููุญููุฉ ููุนูุฏุฉ ุจุงููุนูุ ุงูุชุธุฑ ุงูุชูุงุก ุงูุนููุจุฉ ุงูุญุงููุฉ!")

        active_games[chat_id] = {"players": [], "is_open": True}
        
        # ุชุตููู ูููู ูุจุฏุก ุงูุชุณุฌูู
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "      โฏ ููุญูููููุฉ ุงููุนููููุจูุงุช โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            "๐ข ุจูุงุจ ุงููุชูุณูุฌูููู ููููุชููุญ ุงูุขู!\n"
            "โ๏ธ ูููููุดุงุฑูุฉ: ุฃุฑุณู ูููุฉ ( ุฃูุง ) ุจุงูุฑุฏ ุนูู ูุฐู ุงูุฑุณุงูุฉ.\n\n"
            "โฑ๏ธ ุฃููุงููููู 20 ุซูุงููููุฉ ููุญูุตูุฑ ุงูุถุญุงูุง..."
        )
        msg = bot.send_message(chat_id, text)
        active_games[chat_id]["msg_id"] = msg.message_id
        
        # ุงุณุชุฎุฏุงู Thread ูุนุฏู ุชุนุทูู ุงูุจูุช ุฃุซูุงุก ุงูุงูุชุธุงุฑ
        threading.Timer(20, process_penalty, args=[chat_id, bot]).start()

    @bot.message_handler(func=lambda m: m.chat.id in active_games and active_games[m.chat.id]["is_open"])
    def register_player(m):
        chat_id = m.chat.id
        if m.reply_to_message and m.reply_to_message.message_id == active_games[chat_id]["msg_id"]:
            if m.text == "ุฃูุง" or m.text == "ุงูุง":
                player = {"id": m.from_user.id, "name": m.from_user.first_name}
                if player not in active_games[chat_id]["players"]:
                    active_games[chat_id]["players"].append(player)

    def process_penalty(chat_id, bot):
        if chat_id not in active_games: return
        
        players = active_games[chat_id]["players"]
        active_games[chat_id]["is_open"] = False # ุฅุบูุงู ุงูุชุณุฌูู
        
        if len(players) < 1:
            bot.send_message(chat_id, "โ๏ธ ุตูุฏุฑ ุญูููู ุงููุจูุฑุงุกุฉ ููุฌููุน.. ูู ูุณุฌู ุฃุญุฏ ูู ุงููุญููุฉ!")
        else:
            # ุงุฎุชูุงุฑ ุงูุถุญูุฉ ูุงูุนููุจุฉ
            victim = random.choice(players)
            penalty = random.choice(PENALTIES_LIST)
            
            # ุชุตููู ูููู ูุตุฏูุฑ ุงูุญูู
            result_text = (
                "โโโโโโโโ โ โโโโโโโโ\n"
                "         โฏ ุตูุฏูุฑ ุงููุญูููู โฏ\n"
                "โโโโโโโโ โ โโโโโโโโ\n\n"
                f"๐ค ุงููุถูุญูููุฉ : [{victim['name']}](tg://user?id={victim['id']})\n"
                "โ๏ธ ุงููููุฑุงุฑ : ุฌูุงุฑู ุงููุชููููููุฐ ููุฑุงู\n\n"
                f"๐ฅ **ุนููููุจูุชูู ููู :**\n"
                f"ยซ {penalty} ยป\n\n"
                "๐ ููููุฐ ุจูุตูููุช ููุง ุชูุญูุงูู ุงููููุฑุจ!"
            )
            bot.send_message(chat_id, result_text, parse_mode="Markdown")
        
        del active_games[chat_id]
