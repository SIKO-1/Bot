import random
import db_manager

def register_level_handlers(bot):
    
    # ğŸ“œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø¨Ø£Ø³Ø¹Ø§Ø±Ù‡Ø§ Ø§Ù„Ù…Ø®ÙØ¶Ø© Ø¬Ø¯Ø§Ù‹
    RANKS = {
        "Ù…Ø¨ØªØ¯Ø¦": 0, "Ù…ÙƒØ§ÙØ­": 50, "ØµÙŠØ§Ø¯": 150, "Ø¬Ù†Ø¯ÙŠ": 300, "ÙØ§Ø±Ø³": 500,
        "Ù…ØºÙˆØ§Ø±": 800, "Ù‚Ù†Ø§Øµ": 1200, "Ø²Ø¹ÙŠÙ…": 2000, "Ø´ÙŠØ®": 3500, "Ø¨Ø§Ø´Ø§": 5000,
        "Ø³ÙÙŠØ±": 7000, "ÙˆØ²ÙŠØ±": 10000, "Ø­Ø§ÙƒÙ…": 15000, "Ø³Ù„Ø·Ø§Ù†": 20000, "Ù…Ù„Ùƒ": 30000,
        "Ø¯ÙˆÙ‚": 45000, "Ø¨Ø§Ø±ÙˆÙ†": 60000, "ÙƒÙˆÙ†Øª": 80000, "Ù…Ø§Ø±ÙƒÙŠØ²": 100000, "Ø£Ù…ÙŠØ±": 150000,
        "ÙˆÙ„ÙŠ Ø¹Ù‡Ø¯": 200000, "Ø¬Ù†Ø±Ø§Ù„": 300000, "Ù…Ø´ÙŠØ±": 500000, "Ø£Ø³Ø·ÙˆØ±Ø©": 1000000, "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±": 9999999
    }

    # ğŸ“œ Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© Ø§Ù„ØªØ­ÙÙŠØ²ÙŠØ©
    MOTIVATION = [
        "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØªÙ†Ø§ ØªÙØªØ®Ø± Ø¨ÙˆØ¬ÙˆØ¯ Ø¹Ø¸ÙŠÙ… Ù…Ø«Ù„Ùƒ Ø¨ÙŠÙ† ØµÙÙˆÙÙ‡Ø§! ğŸ‘‘",
        "Ø®Ø·ÙˆØ§ØªÙƒ Ø«Ø§Ø¨ØªØ© Ù†Ø­Ùˆ Ø§Ù„Ù‚Ù…Ø©ØŒ Ù„Ø§ Ø£Ø­Ø¯ ÙŠØ³ØªØ·ÙŠØ¹ Ø¥ÙŠÙ‚Ø§ÙÙƒ! ğŸ”¥",
        "Ø§Ù„Ù…Ø³ØªØ­ÙŠÙ„ ÙƒÙ„Ù…Ø© Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙŠ Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¹Ø¸Ù…Ø§Ø¡ØŒ ÙˆØ£Ù†Øª Ø£Ø­Ø¯Ù‡Ù…! âœ¨",
        "Ø¨Ø±ÙŠÙ‚ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø£Ø¶Ø§Ø¡ Ø£Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ±! ğŸŒŸ"
    ]

    # 1. Ù†Ø¸Ø§Ù… Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    @bot.message_handler(func=lambda m: True)
    def auto_xp_system(m):
        # Ø²ÙŠØ§Ø¯Ø© Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø© Ù…Ø¹ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø© (Ø£Ùˆ Ø£Ù…Ø±)
        leveled_up, new_lvl = db_manager.update_xp(m.from_user.id, 5)
        
        if leveled_up:
            gift = random.randint(1, 500)
            db_manager.update_balance(m.from_user.id, gift)
            quote = random.choice(MOTIVATION)
            congratulations = (
                "ğŸŠ **ØªÙ€Ø±Ù‚Ù€ÙŠÙ€Ø© Ù…Ù€Ù„Ù€ÙƒÙ€ÙŠÙ€Ø© Ù†Ù€Ø§Ø¯Ø±Ø©!** ğŸŠ\n"
                "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
                f"ğŸ†™ ØµØ¹Ø¯Øª Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø¸ÙŠÙ…: **{new_lvl}**\n"
                f"ğŸ Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¯ÙŠÙˆØ§Ù†: **{gift} Ø°Ù‡Ø¨Ø©**\n\n"
                f"ğŸ“œ {quote}\n"
                "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
            )
            bot.reply_to(m, congratulations, parse_mode="Markdown")

        # 2. Ø£Ù…Ø± "Ù…Ø³ØªÙˆÙ‰" Ø£Ùˆ "Ù…Ø³ØªÙˆØ§ÙŠ"
        if m.text in ["Ù…Ø³ØªÙˆÙ‰", "Ù…Ø³ØªÙˆØ§ÙŠ"]:
            user = db_manager.get_user(m.from_user.id)
            lvl = user.get('level', 1)
            rank = db_manager.get_rank(m.from_user.id)
            xp = user.get('xp', 0)
            difficulty = (lvl // 50) + 1
            needed = lvl * (10 * difficulty)
            
            status_text = (
                "ğŸ“Š **Ø§Ù„Ù€Ø³Ù€Ø¬Ù€Ù„ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠ Ù„Ù€Ù„Ù€Ù…Ù€ÙˆØ§Ø·Ù€Ù†** ğŸ“Š\n"
                "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
                f"ğŸ‘¤ Ø§Ù„Ø§Ø³Ù€Ù…: {m.from_user.first_name}\n"
                f"ğŸ‘‘ Ø§Ù„Ù€Ø±ØªØ¨Ù€Ø©: **[{rank}]**\n"
                f"â­ Ø§Ù„Ù€Ù…Ù€Ø³Ù€ØªÙ€ÙˆÙ‰: {lvl}\n"
                f"ğŸ“ˆ Ø§Ù„Ù€Ø®Ù€Ø¨Ù€Ø±Ø©: {xp}/{needed}\n"
                f"âš–ï¸ Ø§Ù„Ù€ØµÙ€Ø¹Ù€ÙˆØ¨Ù€Ø©: x{difficulty}\n"
                "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”"
            )
            bot.reply_to(m, status_text, parse_mode="Markdown")

        # 3. Ø£Ù…Ø± "Ø±ØªØ¨" Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        elif m.text == "Ø±ØªØ¨":
            ranks_list = "ğŸ“œ **Ù‚Ù€Ø§Ø¦Ù€Ù…Ù€Ø© Ø§Ù„Ù€Ù…Ù€Ø±Ø§ØªÙ€Ø¨ Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠÙ€Ø©** ğŸ“œ\n"
            ranks_list += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            for name, price in RANKS.items():
                if name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±":
                    ranks_list += f"ğŸ‘‘ {name} Â» (Ø¨Ø¥Ø°Ù† Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± ÙÙ‚Ø·)\n"
                else:
                    ranks_list += f"ğŸ”¹ {name} Â» {price} Ø°Ù‡Ø¨Ø©\n"
            ranks_list += "â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”\n"
            ranks_list += "ğŸ’¡ Ø§ÙƒØªØ¨ (Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© + Ø§Ù„Ø§Ø³Ù…) Ù„Ù„ØªØ±Ù‚ÙŠØ©"
            bot.reply_to(m, ranks_list, parse_mode="Markdown")

        # 4. Ø£Ù…Ø± "Ø±ØªØ¨ØªÙŠ"
        elif m.text == "Ø±ØªØ¨ØªÙŠ":
            rank = db_manager.get_rank(m.from_user.id)
            bot.reply_to(m, f"ğŸ›¡ï¸ Ø±ØªØ¨ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙÙŠ Ø³Ø¬Ù„Ø§ØªÙ†Ø§ Ù‡ÙŠ: **[{rank}]**")

        # 5. Ø£Ù…Ø± Ø´Ø±Ø§Ø¡ Ø§Ù„Ø±ØªØ¨Ø©
        elif m.text and m.text.startswith("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© "):
            rank_name = m.text.replace("Ø´Ø±Ø§Ø¡ Ø±ØªØ¨Ø© ", "").strip()
            uid = str(m.from_user.id)
            
            if rank_name == "Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±":
                bot.reply_to(m, "âš ï¸ **ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù„ÙƒÙŠ:** Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§ØºØªØµØ§Ø¨ Ø§Ù„Ø¹Ø±Ø´! Ø±ØªØ¨Ø© Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ± ØªÙÙ…Ù†Ø­ ÙÙ‚Ø· Ø¨Ù‚Ø±Ø§Ø± Ø³ÙŠØ§Ø¯ÙŠ.")
                return

            if rank_name in RANKS:
                price = RANKS[rank_name]
                bal = db_manager.get_balance(uid)
                if bal >= price:
                    db_manager.update_balance(uid, -price)
                    db_manager.set_rank(uid, rank_name)
                    bot.reply_to(m, f"âœ… **ØªÙ€Ù…Ù€Øª Ø§Ù„Ù€ØªÙ€Ø±Ù‚Ù€ÙŠÙ€Ø©!**\nÙ…Ø¨Ø§Ø±Ùƒ Ù„Ùƒ Ø±ØªØ¨Ø© **[{rank_name}]** Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©.")
                else:
                    bot.reply_to(m, f"âŒ **Ø¹ÙÙˆØ§Ù‹!** Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…Ù„ÙƒÙŠ ÙŠÙ†Ù‚ØµÙ‡ {price - bal} Ø°Ù‡Ø¨Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù‚Ø§Ù….")
