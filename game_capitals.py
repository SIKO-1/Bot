import random
from telebot import types
import db_manager # ุงูุฑุจุท ุจุงูุฎุฒูุฉ ุงูููููุฉ

def register_handlers(bot):
    
    # ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูุฏููุฉ: ุงูุนุงุตูุฉ) - ููุง ูู ุจุฏูู ุชุบููุฑ
    CAPITALS_DB = {
        "ุงูุนุฑุงู": "ุจุบุฏุงุฏ", "ุงูุณุนูุฏูุฉ": "ุงูุฑูุงุถ", "ูุตุฑ": "ุงููุงูุฑุฉ", "ุณูุฑูุง": "ุฏูุดู",
        "ุงูุฃุฑุฏู": "ุนูุงู", "ููุณุทูู": "ุงููุฏุณ", "ูุจูุงู": "ุจูุฑูุช", "ุงููููุช": "ุงููููุช",
        "ูุทุฑ": "ุงูุฏูุญุฉ", "ุงูุฅูุงุฑุงุช": "ุฃุจูุธุจู", "ุงููุบุฑุจ": "ุงูุฑุจุงุท", "ุงูุฌุฒุงุฆุฑ": "ุงูุฌุฒุงุฆุฑ",
        "ุชููุณ": "ุชููุณ", "ููุจูุง": "ุทุฑุงุจูุณ", "ุงูุณูุฏุงู": "ุงูุฎุฑุทูู", "ุชุฑููุง": "ุฃููุฑุฉ",
        "ุฅูุฑุงู": "ุทูุฑุงู", "ุฃูุบุงูุณุชุงู": "ูุงุจู", "ูุฑูุณุง": "ุจุงุฑูุณ", "ุฃููุงููุง": "ุจุฑููู",
        "ุฅูุทุงููุง": "ุฑููุง", "ุฅุณุจุงููุง": "ูุฏุฑูุฏ", "ุจุฑูุทุงููุง": "ููุฏู", "ุฑูุณูุง": "ููุณูู",
        "ุงูุตูู": "ุจููู", "ุงููุงุจุงู": "ุทูููู", "ููุฑูุง ุงูุฌููุจูุฉ": "ุณููู", "ุงูููุฏ": "ูููุฏููู",
        "ุจุงูุณุชุงู": "ุฅุณูุงู ุขุจุงุฏ", "ุงูููุงูุงุช ุงููุชุญุฏุฉ": "ูุงุดูุทู", "ููุฏุง": "ุฃูุชุงูุง", "ุงูุจุฑุงุฒูู": "ุจุฑุงุฒูููุง",
        "ุงูุฃุฑุฌูุชูู": "ุจูููุณ ุขูุฑุณ", "ุงูููุณูู": "ููุณููู ุณูุชู", "ุฃุณุชุฑุงููุง": "ูุงูุจูุฑุง", "ูููุฒูููุฏุง": "ูููููุบุชูู",
        "ุฌููุจ ุฃูุฑูููุง": "ุจุฑูุชูุฑูุง", "ููุฌูุฑูุง": "ุฃุจูุฌุง", "ููููุง": "ููุฑูุจู", "ุฅุซููุจูุง": "ุฃุฏูุณ ุฃุจุงุจุง",
        "ุงูุณููุฏ": "ุณุชูููููู", "ุงููุฑููุฌ": "ุฃูุณูู", "ููููุฏุง": "ููุณููู", "ุณููุณุฑุง": "ุจุฑู",
        "ุงูููุณุง": "ููููุง", "ุจูุฌููุง": "ุจุฑููุณู", "ุงููููุงู": "ุฃุซููุง", "ุงูุจุฑุชุบุงู": "ูุดุจููุฉ",
        "ุชุดููู": "ุณุงูุชูุงุบู", "ุจูุฑู": "ูููุง"
    }

    active_capitals = {}

    @bot.message_handler(func=lambda m: m.text == "ุนูุงุตู")
    def start_capital_game(m):
        chat_id = m.chat.id
        country, capital = random.choice(list(CAPITALS_DB.items()))
        
        active_capitals[chat_id] = capital
        
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "         โฏ ุชูุญูุฏู ุงููุนููุงุตูู โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            "โก๏ธ ููู ุงูุฃุณูุฑุน ุ\n"
            f"๐ ููุง ููู ุนูุงุตูููุฉ : [ **{country}** ]\n\n"
            "๐ฐ ุงููุฌูุงุฆุฒุฉ : 40 ุฐูุจุฉ\n"
            "โ๏ธ ุฃุฑุณู ุงูุฅุฌุงุจุฉ ุงูุขู ูู ุงูุดุงุช!"
        )
        bot.send_message(chat_id, text, parse_mode="Markdown")

    @bot.message_handler(func=lambda m: m.chat.id in active_capitals)
    def check_capital(m):
        chat_id = m.chat.id
        # ุชุฌูุจ ูุนุงูุฌุฉ ุงูุฃูุงูุฑ ูุฅุฌุงุจุงุช (ูุซู "ูุณุญ" ุฃู "ุงูุฏู") ูุชูุงุฏู ุงูุชุนููู
        if m.text and m.text.startswith(('/', '!', '#')):
            return

        correct_answer = active_capitals[chat_id]
        
        # ุชุญุณูู ูุทุงุจูุฉ ุงูุฅุฌุงุจุฉ (ุชุทุจูุน ุงูุญุฑูู)
        def normalize(t):
            return t.strip().replace("ุฃ", "ุง").replace("ุฅ", "ุง").replace("ุข", "ุง").replace("ุฉ", "ู")

        if normalize(m.text) == normalize(correct_answer):
            uid = m.from_user.id
            
            # ุฅุถุงูุฉ ุงูุฐูุจ ููุฎุฒูุฉ ุงูููููุฉ
            db_manager.update_user_gold(uid, 40)
            
            win_text = (
                "โฏ ุบูุฒู ุฌูุบูุฑุงููู ููุงุฌูุญ โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููููุงุฆูุฒ : {m.from_user.first_name}\n"
                f"โ ุงูุฅุฌูุงุจูุฉ : {correct_answer}\n"
                "๐ฐ ุงููุฌููุงุฆูุฒ : +40 ุฐููุจูุฉ"
            )
            bot.reply_to(m, win_text)
            # ูุณุญ ุงููุนุจุฉ ููุฑุงู ูุชุญุฑูุฑ ุงูุจูุช
            del active_capitals[chat_id]
