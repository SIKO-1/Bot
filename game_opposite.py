import random
from telebot import types

# ูุธุงู ุงูููุงุท
try:
    from db_manager import get_user, update_user
except:
    def get_user(uid): return {"balance": 0}
    def update_user(uid, k, v): pass

def register_handlers(bot):
    # ุจูู ุงููููุงุช - 50 ูููุฉ ูุฎูุฉ
    OPPOSITES = {
        "ููู": "ุถุนูู", "ุณุฑูุน": "ุจุทูุก", "ูุจูุฑ": "ุตุบูุฑ", "ุญุงุฑ": "ุจุงุฑุฏ",
        "ููุงุฑ": "ููู", "ุฌููู": "ูุจูุญ", "ุฐูู": "ุบุจู", "ุณุนูุฏ": "ุญุฒูู",
        "ุบูู": "ูููุฑ", "ุทููู": "ูุตูุฑ", "ูุงุณุน": "ุถูู", "ุณููู": "ูุญูู",
        "ุนุงูู": "ููุฎูุถ", "ูุฑูุจ": "ุจุนูุฏ", "ุฌุฏูุฏ": "ูุฏูู", "ุณูู": "ุตุนุจ",
        "ูุฌุงุญ": "ูุดู", "ุดุฌุงุน": "ุฌุจุงู", "ูุฑูู": "ุจุฎูู", "ุตุงุฏู": "ูุงุฐุจ",
        "ุฃูุงูุฉ": "ุฎูุงูุฉ", "ุนุฏู": "ุธูู", "ุชูุงุถุน": "ุชูุงุฎุฑ", "ูุฏูุก": "ุถุฌูุฌ",
        "ุญูุงุฉ": "ููุช", "ููุฑ": "ุธูุงู", "ุญู": "ุจุงุทู", "ุฌูุฉ": "ูุงุฑ",
        "ุณูุงุก": "ุฃุฑุถ", "ุจุญุฑ": "ุจุฑ", "ุดุฑู": "ุบุฑุจ", "ุดูุงู": "ุฌููุจ",
        "ุจุฏุงูุฉ": "ููุงูุฉ", "ุฃูู": "ุขุฎุฑ", "ุตุนูุฏ": "ูุจูุท", "ููุฒ": "ุฎุณุงุฑุฉ",
        "ุจูุงุก": "ูุฏู", "ุฌูุน": "ุทุฑุญ", "ุถุฑุจ": "ูุณูุฉ", "ูุฏุญ": "ุฐู",
        "ุซููู": "ุฎููู", "ูุงุนู": "ุฎุดู", "ุญูู": "ูุฑ", "ูุงุจุณ": "ุฑุทุจ",
        "ููููุก": "ูุงุฑุบ", "ููุชูุญ": "ูุบูู", "ูุธูู": "ูุชุณุฎ", "ุซุจุงุช": "ุญุฑูุฉ",
        "ููุธุฉ": "ููู", "ุธุงูุฑ": "ุจุงุทู"
    }

    active_games = {}

    # ุงูุงุณุชุฌุงุจุฉ ูุฃูุฑ "ุนูุณ" ููุท
    @bot.message_handler(func=lambda m: m.text == "ุนูุณ")
    def start_game(m):
        word = random.choice(list(OPPOSITES.keys()))
        active_games[m.chat.id] = OPPOSITES[word]
        
        # ุฒุฎุฑูุฉ ูุฎูุฉ ูุชุบููุฑ ุงูุงุณู ุฅูู "ุนูุณ"
        text = (
            "โโโโโโโโ โ โโโโโโโโ\n"
            "         โฏ ุชูุญูุฏู ุงููุนูููุณ โฏ\n"
            "โโโโโโโโ โ โโโโโโโโ\n\n"
            f"  ยป ููุง ููู ุนูููุณ ููููููุฉ : [ {word} ]\n\n"
            "โ๏ธ ุฃุฑุณู ุงูุนูุณ ุงูุตุญูุญ ุงูุขู\n"
            "๐ฐ ุงููุฌูุงุฆูุฒุฉ : 25 ููููุทูุฉ"
        )
        bot.send_message(m.chat.id, text)

    @bot.message_handler(func=lambda m: m.chat.id in active_games)
    def check_answer(m):
        chat_id = m.chat.id
        if m.text == active_games[chat_id]:
            uid = m.from_user.id
            bal = get_user(uid).get("balance", 0)
            update_user(uid, "balance", bal + 25)
            
            win_text = (
                "โฏ ุชูู ุงููุชูุญูููู ููู ุงูุฅุฌูุงุจูุฉ โฏ\n"
                "โโโโโโโโโโโโโโ\n"
                f"๐ค ุงููููุงุฆูุฒ : {m.from_user.first_name}\n"
                "โ ุงูุฅุฌูุงุจูุฉ : ุตูุญูููุญูุฉ\n"
                "๐ฐ ุงููุฌููุงุฆูุฒ : +25 ููููุงุท"
            )
            bot.reply_to(m, win_text)
            del active_games[chat_id]
