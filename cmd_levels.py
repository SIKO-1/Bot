import random
import db_manager

def register_handlers(bot):
    
    # ุงูุณุฌู ุงูุฑุณูู ููุฑุชุจ ุงูุฅูุจุฑุงุทูุฑูุฉ (25 ุฑุชุจุฉ)
    RANKS = {
        "ูุจุชุฏุฆ": 0, "ููุงูุญ": 50, "ุตูุงุฏ": 150, "ุฌูุฏู": 300, "ูุงุฑุณ": 500,
        "ูุบูุงุฑ": 800, "ููุงุต": 1200, "ุฒุนูู": 2000, "ุดูุฎ": 3500, "ุจุงุดุง": 5000,
        "ุณููุฑ": 7000, "ูุฒูุฑ": 10000, "ุญุงูู": 15000, "ุณูุทุงู": 20000, "ููู": 30000,
        "ุฏูู": 40000, "ุจุงุฑูู": 50000, "ูููุช": 60000, "ูุงุฑููุฒ": 75000, "ุฃููุฑ": 100000,
        "ููู ุนูุฏ": 150000, "ุฌูุฑุงู": 250000, "ูุดูุฑ": 400000, "ุฃุณุทูุฑุฉ": 700000, "ุฅูุจุฑุงุทูุฑ": 9999999
    }

    # ุงูุฃููุงู ุงูุฅูุจุฑุงุทูุฑูุฉ ุงููุฃุซูุฑุฉ
    ROYAL_QUOTES = [
        "ุฅู ุงููุฌุฏ ูุง ูููุงู ุฅูุง ุจุงูุตุจุฑ ูุงููุซุงุจุฑุฉ ูู ุฎุฏูุฉ ุงูุนุฑุด.",
        "ุนุธูุชูุง ุชุณุชูุฏ ููุชูุง ูู ุฅุฎูุงุตูู ูุชูุงูููู ุงููุณุชูุฑ.",
        "ุงูููุฉ ููุณุช ููุงูุงู ูุตู ุฅูููุ ุจู ูู ููุงู ูููู ุจู ุจุฃูุนุงููุง.",
        "ุจูุงุก ุงูุฅูุจุฑุงุทูุฑูุฉ ูุชุทูุจ ุฑุฌุงูุงู ูุง ุชุนุฑู ุงููุณุชุญูู."
    ]

    # 1. ุฃูุฑ ุนุฑุถ ุงููุณุชูู (ุจุฃุณููุจ ุฑุณูู)
    @bot.message_handler(func=lambda m: m.text in ["ูุณุชูู", "ูุณุชูุงู"])
    def show_royal_status(m):
        u = db_manager.get_user(m.from_user.id)
        lvl, xp, rank = u['level'], u['xp'], u.get('rank', 'ูุจุชุฏุฆ')
        diff = (lvl // 50) + 1
        needed = lvl * (10 * diff)
        
        status_msg = (
            "๐ **ูุซูููููุฉ ุงููุญูุงููุฉ ุงููููููููููุฉ** ๐\n"
            "โโโโโโโโโโโโโโโโ\n"
            f"๐ค ุงููุญูุงููู : {m.from_user.first_name}\n"
            f"๐ ุงููุฑุชุจูุฉ : {rank}\n"
            f"โญ ุงููููุณูุชููู : {lvl}\n"
            f"๐ ุงููููููุงุท : {xp} / {needed}\n"
            f"๐ ุงููุตูุนููุจูุฉ : x{diff}\n"
            "โโโโโโโโโโโโโโโโ\n"
            "ุตูุฏุฑุช ูู ุงูุฏููุงู ุงูุฅูุจุฑุงุทูุฑู"
        )
        bot.reply_to(m, status_msg)

    # 2. ุฃูุฑ ุนุฑุถ ุงูุฑุชุจ (ุจุฃุณููุจ ุงูุณุฌูุงุช)
    @bot.message_handler(func=lambda m: m.text == "ุฑุชุจ")
    def list_imperial_ranks(m):
        ranks_text = "๐ **ุณูุฌูู ุงููููุฑุงุชูุจ ุงูุฅููุจูุฑุงุทููุฑููุฉ** ๐\n"
        ranks_text += "โโโโโโโโโโโโโโโโ\n"
        for i, (name, price) in enumerate(RANKS.items()):
            price_label = "ุณูุงุฏู" if name == "ุฅูุจุฑุงุทูุฑ" else f"{price} ุฐูุจุฉ"
            ranks_text += f"โ๏ธ {name} : {price_label}\n"
            if (i+1) % 5 == 0: ranks_text += "โ\n"
        ranks_text += "โโโโโโโโโโโโโโโโ\n"
        ranks_text += "ูุทูุจ ุงูุชุฑููุฉ: (ุดุฑุงุก ุฑุชุจุฉ + ุงูุงุณู)"
        bot.reply_to(m, ranks_text)

    # 3. ูุธุงู ุงูุชุฑููุฉ ุงูุชููุงุฆู (ุงููุฑุณูู ุงููููู)
    @bot.message_handler(func=lambda m: True)
    def handle_imperial_xp(m):
        # ุงุณุชุซูุงุก ุงูุฃูุงูุฑ ูููุน ุงูุชุนุงุฑุถ
        if m.text in ["ูุณุชูู", "ูุณุชูุงู", "ุฑุชุจ", "ูุนุฑุถ", "ูุชุฌุฑ", "ุฑุชุจุชู"]:
            return

        leveled_up, new_lvl = db_manager.update_xp(m.from_user.id, 5)
        if leveled_up:
            gift = random.randint(1, 500)
            db_manager.update_balance(m.from_user.id, gift)
            quote = random.choice(ROYAL_QUOTES)
            
            royal_decree = (
                "๐บ **ููุฑุณููู ุฅููุจูุฑุงุทููุฑู ุณูุงูู** ๐บ\n"
                "โโโโโโโโโโโโโโโโ\n"
                f"ุชูุฑุฑ ุชุฑููุฉ ุงูููุงุทู ููููููุณูุชููู : {new_lvl}\n"
                f"ุจููุงูุฃุฉ ููููุฉ ูุฏุฑูุง : {gift} ุฐูุจุฉ\n\n"
                f"๐ {quote}\n"
                "โโโโโโโโโโโโโโโโ"
            )
            bot.reply_to(m, royal_decree)
