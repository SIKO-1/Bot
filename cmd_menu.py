import random
from db_manager import get_user

def register_handlers(bot):
    # Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙƒØ¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±
    DEV_ID = 5860391324

    IRAQI_QUOTES = [
        "ÙŠÙ€Ø§ Ø¨Ù€Ø¹Ù€Ø¯ Ø§Ù„Ù€Ø±ÙˆØ­ ÙˆØ§Ù„Ù€Ø¬Ù€Ø¨Ù€Ø¯ ÙˆØ§Ù„Ù€Ø±ÙŠØ©",
        "ÙˆØ¬Ù‡Ù€Ùƒ Ø­Ù€Ù„Ù€Ùˆ Ù…Ù€Ø«Ù€Ù„ ØµÙ€Ù…Ù€ÙˆÙ† Ø¹Ù€Ø±Ø§Ù‚Ù€ÙŠ Ø­Ù€Ø§Ø±",
        "Ø£Ø­Ù€Ø¨Ù€Ùƒ Ø­Ù€Ø¨ Ø§Ù„Ù€Ø¹Ù€Ø±Ø§Ù‚ÙŠ Ù„Ù€Ù„Ù€Ú†Ù€Ø§ÙŠ Ø§Ù„Ù€Ù…Ù€Ù‡Ù€ÙŠÙ€Ù„",
        "Ø§Ù†Ù€Øª Ù…Ù€Ø«Ù€Ù„ Ø§Ù„Ù€ØªÙ€Ø¨Ù€Ø³ÙŠ.. Ù…Ù€Ø­Ù€Ø¯ ÙŠÙ€Ø´Ù€Ø¨Ù€Ø¹ Ù…Ù€Ù†Ù€Ùƒ",
        "ÙŠÙ€Ø§ Ù†Ù€Ø¨Ù€Ø¹ Ø§Ù„Ù€Ø±ÙŠÙ€Ø­Ù€Ø§Ù† Ø¨Ù€Ù†Ù€Øµ Ø¨Ù€ØºÙ€Ø¯Ø§Ø¯",
        "ÙˆØ¬Ù€Ù‡Ù€Ùƒ ÙŠÙ€Ø·Ù€Ø±Ø¯ Ø§Ù„Ù€ÙÙ€ÙƒÙ€Ø± ÙˆÙŠÙ€Ø¬Ù€ÙŠÙ€Ø¨ Ø§Ù„Ù€Ø®Ù€ÙŠÙ€Ø±",
        "Ù„Ù€Ùˆ ÙƒÙ€Ù„ Ø§Ù„Ù€Ø¨Ù€Ø´Ù€Ø± Ù…Ù€Ø«Ù€Ù„Ù€Ùƒ Ú†Ù€Ø§Ù† Ø§Ù„Ù€Ø¯Ù†Ù€ÙŠÙ€Ø§ Ø¨Ù€Ø®Ù€ÙŠÙ€Ø±",
        "Ø¶Ù€Ø­Ù€ÙƒÙ€ØªÙ€Ùƒ ØªÙ€Ø±Ø¯ Ø§Ù„Ù€Ø¹Ù€Ø§ÙÙ€ÙŠÙ€Ø© Ù„Ù€Ù„Ù€Ú¯Ù€Ù„Ù€Ø¨",
        "ÙŠÙ€Ø§ Ø£ÙˆÙ„ Ø¨Ù€Ø´Ù€Ø± ÙŠÙ€Ù…Ù€Ø´Ù€ÙŠ Ø¨Ù€Ù†Ù€Øµ Ø´Ù€Ø±Ø§ÙŠÙ€ÙŠÙ€Ù†Ù€ÙŠ",
        "ÙƒÙ€Ù„Ù€Ùƒ Ø°ÙˆÙ‚ Ù…Ù€Ù† Ø§Ù„Ù€Ø¬Ù€Ø¯Ù… Ù„Ù€Ù„Ù€Ù‡Ù€Ø§Ù…Ù€Ø©",
        "Ø§Ù†Ù€Øª Ø§Ù„Ù€Ø³Ù€Ù†Ù€Ø¯ ÙˆØ§Ù„Ù€Ø¸Ù€Ù‡Ù€Ø± Ø¨Ù€ÙˆÙƒÙ€Øª Ø§Ù„Ù€Ø¶Ù€ÙŠÙ€Ùƒ",
        "ÙŠÙ€Ø§ Ù…Ù€Ù† Ø¬Ù€Ù…Ù€Ø§Ù„Ù€Ùƒ Ù…Ù€Ø«Ù€Ù„ ØºÙ€Ø±ÙˆØ¨ Ø¯Ø¬Ù€Ù„Ù€Ø©",
        "Ø£Ø±ÙŠÙ€Ø¯Ùƒ ÙˆÙŠÙ€Ø§ÙŠ Ù„Ù€Ø­Ù€Ø¯ Ù…Ù€Ø§ ÙŠÙ€Ø·Ù€Ù„Ù€Ø¹ Ù†Ù€Ø®Ù€Ù„ Ø¨Ù€Ø±Ø§Ø³Ù€ÙŠ",
        "Ø¹Ù€ÙŠÙ€ÙˆÙ†Ù€Ùƒ Ø¨Ù€ÙŠÙ€Ù‡Ø§ Ù„Ù€Ù…Ù€Ø¹Ù€Ø© Ù…Ù€Ø«Ù€Ù„ Ø¯Ø¬Ù€Ù„Ù€Ø© ÙˆØ§Ù„Ù€ÙÙ€Ø±Ø§Øª",
        "ÙŠÙ€Ø§ Ø¨Ù€Ø¹Ù€Ø¯ Ø´Ù€ÙŠÙ€Ø¨Ù€ÙŠ ÙˆØ´Ù€Ø¨Ù€Ø§Ø¨Ù€ÙŠ ÙˆØ§Ù„Ù€Ù†Ù€Ø¨Ù€Ø¶ Ù…Ù€Ø§Ù„Ù€ØªÙ€ÙŠ"
    ]

    # 1. Ù‚Ø³Ù… Ø¯ÙŠÙˆØ§Ù† Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Ø§ÙˆØ§Ù…Ø±ØŒ Ø§Ù„Ø§ÙˆØ§Ù…Ø±ØŒ Ù‚Ø§Ø¦Ù…Ø©)
    @bot.message_handler(func=lambda message: message.text in ["Ø§ÙˆØ§Ù…Ø±", "Ø§Ù„Ø£ÙˆØ§Ù…Ø±", "Ø§Ù„Ø§ÙˆØ§Ù…Ø±", "Ù‚Ø§Ø¦Ù…Ø©"])
    def luxury_menu(message):
        # ðŸ”¥ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ: ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø±Ø¤ÙŠØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        user_info = get_user(message.from_user.id)
        if user_info and user_info.get("banned"):
            return 

        name = message.from_user.first_name
        user_id = message.from_user.id
        
        menu_text = (
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            "    Ø§Ù„Ø§ÙˆØ§Ù…Ø± Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© \n"
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            f"Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø§Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©\n"
            f"Ø§Ù„Ø³ÙŠØ¯ : {name}\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"
            "Ù…Ø±Ø§Ø³ÙŠÙ… ÙˆØ£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù…Ù„ÙƒØ© :\n"
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
            "   --  Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ \n"
            "   --  Ø§Ù„Ù…ØªØ¬Ø± \n"
            "   -- Ù…Ø³ØªÙˆÙ‰ \n"
            "   --  Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© \n"
            "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"
        )

        if user_id == DEV_ID:
            menu_text += (
                "\nØ´Ø¤ÙˆÙ† Ø§Ù„Ù‚ØµØ± Ø§Ù„Ø¹Ø§Ù„ÙŠ\n"
                "   -- Ø§Ù„Ø¥Ù…Ù€Ø¨Ù€Ø±Ø§Ø·Ù€ÙˆØ±ÙŠÙ€Ø©\n"
                "( ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø© )\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            )
        
        menu_text += (
            "Ù„Ø¹Ø±Ø¶ Ù‡ÙˆÙŠØªÙƒ Ø£Ø±Ø³Ù„ [ Ø§ ]\n"
            "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
            "ØªØ®Ø¶Ø¹ Ø§Ù„Ø±Ø¹Ø§ÙŠØ§ Ù„Ù‡ÙŠØ¨ØªÙƒ"
        )
        bot.reply_to(message, menu_text)

    # 2. Ù‚Ø³Ù… Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© (Ø§ÙŠØ¯ÙŠØŒ Ø§)
    @bot.message_handler(func=lambda message: message.text in ["Ø§ÙŠØ¯ÙŠ", "Ø§", "ID", "id"])
    def luxury_id(message):
        # ðŸ”¥ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠ: ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù…Ø­Ø¸ÙˆØ± Ù…Ù† Ø±Ø¤ÙŠØ© Ù‡ÙˆÙŠØªÙ‡
        user_info = get_user(message.from_user.id)
        if user_info and user_info.get("banned"):
            return

        try:
            uid = message.from_user.id
            name = message.from_user.first_name
            username = message.from_user.username if message.from_user.username else "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
            
            user_data = get_user(uid)
            if not user_data:
                user_data = {"balance": 0, "rank": "Ù…ÙˆØ§Ø·Ù† Ø¬Ø¯ÙŠØ¯", "messages": 0}
            
            balance = user_data.get("balance", 0)
            rank = user_data.get("rank", "Ù…ÙˆØ§Ø·Ù†")
            
            try:
                full_user = bot.get_chat(uid)
                bio = full_user.bio if full_user.bio else "Ø®Ø§Ù„ÙŠ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª"
                bio = bio.replace("_", "\\_").replace("*", "\\*").replace("`", "\\`")
            except:
                bio = "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­Ø¬ÙˆØ¨Ø©"

            messages_count = user_data.get("messages", 0)
            activity = "Ù…ØªÙØ§Ø¹Ù„ Ù†Ø§Ø± ÙˆØ´Ø¹Ù„Ø©" if messages_count > 500 else "Ù†Ø§ÙŠÙ… Ø¨Ø§Ù„Ø¹Ø³Ù„.. ØªØ­Ø±Ùƒ Ø´ÙˆÙŠØ©"
            account_type = "Ø­Ø³Ø§Ø¨ Ù…Ù„ÙƒÙŠ Ù…Ù…ÙŠØ²" if uid < 2000000000 else "Ø­Ø³Ø§Ø¨ Ø¨Ø±Ø¹ÙŠØ© Ø¨Ø³ÙŠØ·Ø©"
            quote = random.choice(IRAQI_QUOTES)

            id_card = (
                f"â†« {quote}\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                f"âŒï¸™Ø§ÙŠØ¯ÙŠÙ€Úªâ†« {uid}\n"
                f"âŒï¸™Ù…Ø¹Ø±ÙÙ€Úªâ†« @{username}\n"
                f"âŒï¸™Ø­Ø³Ø§Ø¨Ù€Úªâ†« {account_type}\n"
                f"âŒï¸™ØªÙØ§Ø¹Ù„Ù€Úªâ†« {activity}\n"
                f"âŒï¸™Ø±ØµÙŠÙ€Ø¯Úªâ†« {balance}\n"
                f"âŒï¸™Ø§Ù„Ø¨Ù€Ø§ÙŠÙ€Ù€Ù€Ùˆâ†« {bio}\n"
                "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
                f"Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø³ÙŠØ§Ø¯ÙŠØ© : {rank}"
            )

            photos = bot.get_user_profile_photos(uid)
            if photos and photos.total_count > 0:
                bot.send_photo(message.chat.id, photos.photos[0][-1].file_id, caption=id_card)
            else:
                bot.reply_to(message, id_card)
        
        except Exception as e:
            bot.reply_to(message, f"ØªÙ†Ø¨ÙŠÙ‡ Ø³ÙŠØ§Ø¯ÙŠ: Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ø¬Ù‡ Ø¹Ø§Ø¦Ù‚Ø§Ù‹.\nØ§Ù„Ø³Ø¨Ø¨: Ø¨Ø§ÙŠÙˆ Ø­Ø³Ø§Ø¨Ùƒ ÙŠØ­ØªÙˆÙŠ Ø±Ù…ÙˆØ²Ø§Ù‹ ØªÙ…Ù†Ø¹ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠ.")
